---
layout: default
title: Map Index
---
<link rel="stylesheet" href="/codex/assets/css/style.css">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<div class="intro-wrapper">
  <h1>Maps Index</h1>
  <p>
    Searchable index of free battle maps.   
    <a href="/codex/submit">Contribute to the database - submit a map! (login required)</a>
  </p>
</div>

<div class="map-search-wrapper">
  <label for="mapSearchInput">Search Maps:</label>
  <input type="text" id="mapSearchInput" placeholder="Type keywords, name, or creator...">
</div>

<div class="map-gallery" id="gallery-container">
  <p style="text-align:center; color:#666; margin-top: 50px;">Loading library...</p>
</div>

<script>
  /* --- CONFIGURATION --- */
  const SUPABASE_URL = 'https://kcbvryvmcbfpsibxthhn.supabase.co';
  /* ðŸ”´ USE YOUR "anon" KEY HERE ðŸ”´ */
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtjYnZyeXZtY2JmcHNpYnh0aGhuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1OTk1MzIsImV4cCI6MjA3OTE3NTUzMn0.9h81WHRCJfhouquG9tPHliY_5ezAbzKeDoLtGSARo5M'; 
  
  const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  document.addEventListener('DOMContentLoaded', async () => {
    await fetchAndRenderMaps();
  });

  async function fetchAndRenderMaps() {
    const container = document.getElementById('gallery-container');

    /* 1. Fetch Approved Maps */
    const { data: maps, error } = await db
      .from('maps')
      .select('*')
      .eq('is_approved', true)
      .order('created_at', { ascending: false });

    if (error) {
      console.error('Error loading maps:', error);
      container.innerHTML = `<p style="color:var(--palette-danger); text-align:center;">Error loading maps.</p>`;
      return;
    }

    if (!maps || maps.length === 0) {
      container.innerHTML = `<p style="text-align:center;">No maps found.</p>`;
      return;
    }

    /* 2. Clear Loading Text */
    container.innerHTML = '';

    /* 3. Generate HTML */
    maps.forEach(map => {
      const card = document.createElement('div');
      card.className = 'map-card';
      
      const searchString = `${map.name} ${map.creator} ${map.keywords || ''}`.toLowerCase();
      card.setAttribute('data-search', searchString);

      card.innerHTML = `
        <a href="${map.image_url}" class="map-thumbnail-link" target="_blank" rel="noopener noreferrer">
          <img src="${map.image_url}" alt="Thumbnail for ${map.name}" class="map-thumbnail" loading="lazy">
        </a>

        <div class="map-card-info">
          <h2>${map.name}</h2>
          <p><strong>Creator:</strong> ${map.creator}</p>
          
          ${ map.grid_width ? `<p><strong>Dimensions:</strong> ${map.grid_width}x${map.grid_height}</p>` : '' }

          <p><strong>Image URL:</strong></p>
          <div class="copy-wrapper">
            <code class="copy-target">${map.image_url}</code>
            <button class="copy-button" type="button">Copy</button>
          </div>

          <p><strong>Avrae Map Code:</strong></p>
          <div class="copy-wrapper">
            <code class="copy-target">${map.avrae_cmd || 'Not Submitted'}</code>
            <button class="copy-button" type="button">Copy</button>
          </div>

          <p><strong>Keywords:</strong> <span style="font-size: 0.9em; color: var(--color-text-muted);">${map.keywords || 'None'}</span></p>
          
          <p style="font-size: 0.8em; margin-top: 10px; color: var(--color-text-muted);">
            <em>Submitted by: ${map.submitted_by || 'Anonymous'}</em>
          </p>
        </div>
      `;

      container.appendChild(card);
    });

    setupInteractions();
  }

  function setupInteractions() {
    /* Search Logic */
    const searchInput = document.getElementById('mapSearchInput');
    const allMapCards = document.querySelectorAll('.map-card');

    searchInput.addEventListener('keyup', () => {
      const filterText = searchInput.value.toLowerCase().trim();
      
      allMapCards.forEach(card => {
        const cardData = card.getAttribute('data-search');
        if (cardData.includes(filterText)) {
          card.style.display = 'flex'; 
        } else {
          card.style.display = 'none';
        }
      });
    });

    /* Copy Button Logic */
    const allCopyButtons = document.querySelectorAll('.copy-button');
    
    allCopyButtons.forEach(button => {
      button.addEventListener('click', () => {
        const codeElement = button.previousElementSibling;
        const textToCopy = codeElement.innerText;
        
        navigator.clipboard.writeText(textToCopy).then(() => {
          const originalText = button.innerText;
          button.innerText = 'Copied!';
          button.style.background = 'var(--palette-success)';
          button.style.color = 'white';
          
          setTimeout(() => {
            button.innerText = originalText;
            button.style.background = ''; 
            button.style.color = '';
          }, 2000);
        }).catch(err => {
          console.error('Failed to copy text: ', err);
        });
      });
    });
  }
</script>