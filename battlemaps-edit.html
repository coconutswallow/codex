<script type="module">
  /* FIX: Use "/assets/..." instead of "../assets/..." 
     This ensures it finds the folder regardless of where this file is located.
  */
  import { supabase } from "assets/js/supabaseClient.js";
  import { uploadImage } from "assets/js/imagekit-upload.js";

  const params = new URLSearchParams(window.location.search);
  const mapId = params.get("id");

  // Elements
  const fileInput = document.getElementById("ik-file");
  const urlInput = document.getElementById("ik-url");
  const gridW = document.getElementById("gridW");
  const gridH = document.getElementById("gridH");
  const previewContainer = document.getElementById("preview-container");
  const previewImg = document.getElementById("preview");
  const fullSizeLink = document.getElementById("full-size-link");
  const detectMsg = document.getElementById("detect-msg");
  const btn = document.getElementById("submit-btn"); // Defined here to be safe

  let currentUser = null;
  let existingImageUrl = null;

  /* -------------------------
     AUTH CHECK
  ------------------------- */
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    alert("You must be logged in to submit maps.");
    window.location.href = "/battlemaps-view.html";
  }
  currentUser = user;

  /* -------------------------
     AUTO-DETECT LOGIC
  ------------------------- */
  fileInput.addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    urlInput.value = ""; // Clear URL if file picked
    
    detectDimensions(file.name);
    const objectUrl = URL.createObjectURL(file);
    showPreview(objectUrl);
  });

  urlInput.addEventListener("input", (e) => {
    const url = e.target.value.trim();
    if (!url) {
      previewContainer.style.display = "none";
      return;
    }
    fileInput.value = ""; // Clear file if URL typed
    showPreview(url);
  });

  function detectDimensions(text) {
    // Regex: Number 'x' Number (e.g. 30x20)
    const match = text.match(/(\d+)\s?[xX]\s?(\d+)/);
    if (match) {
      gridW.value = match[1];
      gridH.value = match[2];
      detectMsg.textContent = `Auto-detected grid size: ${match[1]} x ${match[2]}`;
    } else {
      detectMsg.textContent = "";
    }
  }

  function showPreview(src) {
    previewImg.src = src;
    fullSizeLink.href = src;
    previewContainer.style.display = "block";
  }

  /* -------------------------
     LOAD EXISTING (EDIT MODE)
  ------------------------- */
  if (mapId) {
    document.getElementById("page-title").innerText = "Edit Battle Map";
    
    const { data, error } = await supabase
      .from("battlemaps")
      .select("*")
      .eq("id", mapId)
      .single();

    if (!error && data) {
      document.getElementById("name").value = data.name;
      gridW.value = data.grid_width;
      gridH.value = data.grid_height;
      document.getElementById("creator").value = data.creator;
      document.getElementById("source").value = data.source_url || "";
      document.getElementById("keywords").value = data.keywords || "";
      document.getElementById("freeUse").checked = data.is_free_use;

      existingImageUrl = data.image_url;
      showPreview(existingImageUrl);
    }
  }

  /* -------------------------
     SUBMIT HANDLER
  ------------------------- */
  document.getElementById("map-form").addEventListener("submit", async (e) => {
    e.preventDefault(); // STOP THE PAGE REFRESH

    btn.textContent = "Saving...";
    btn.disabled = true;

    let finalImageUrl = existingImageUrl;

    // 1. Handle File Upload
    if (fileInput.files.length > 0) {
      const upload = await uploadImage();
      if (!upload) {
        alert("Image upload failed.");
        resetButton();
        return;
      }
      finalImageUrl = upload.url;
    } 
    // 2. Handle URL
    else if (urlInput.value) {
      if (urlInput.value !== existingImageUrl) {
         finalImageUrl = urlInput.value;
      }
    }

    if (!finalImageUrl) {
      alert("Please upload a map image or provide a URL.");
      resetButton();
      return;
    }

    const payload = {
      name: document.getElementById("name").value,
      grid_width: +gridW.value,
      grid_height: +gridH.value,
      creator: document.getElementById("creator").value,
      source_url: document.getElementById("source").value,
      keywords: document.getElementById("keywords").value,
      is_free_use: document.getElementById("freeUse").checked,
      image_url: finalImageUrl,
      submitted_by: currentUser.id
    };

    let result;
    if (mapId) {
      result = await supabase.from("battlemaps").update(payload).eq("id", mapId);
    } else {
      result = await supabase.from("battlemaps").insert(payload);
    }

    if (result.error) {
      console.error(result.error);
      alert("Error saving map: " + result.error.message);
      resetButton();
    } else {
      window.location.href = "/battlemaps-view.html";
    }
  });

  function resetButton() {
    btn.textContent = "Save Map";
    btn.disabled = false;
  }
</script>