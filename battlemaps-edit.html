---
layout: default
title: Submit / Edit Battle Map
---

{% include auth-header.html %}

<section class="hero-block">
  <h1 id="page-title">Submit Battle Map</h1>
  <p>Share a map with the community.</p>
</section>

<script type="text/javascript" src="https://unpkg.com/imagekit-javascript/dist/imagekit.min.js"></script>

<div class="submit-container" style="display: block; max-width: 800px; margin: 40px auto;">
  
  <form id="map-form" class="controls">
    
    <div class="section">
      <label for="name">Map Name</label>
      <input id="name" type="text" placeholder="e.g. Forest Ambush" required />
    </div>

    <div class="section">
      <label>Map File</label>
      <p style="font-size: 0.85em; color: var(--color-text-muted); margin-top:0;">
        Upload a file OR paste a direct URL.
      </p>
      
      <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
        <input type="file" id="ik-file" accept="image/*" style="flex: 1; min-width: 200px;" />
        <span style="font-weight: bold; color: var(--color-text-muted);">OR</span>
        <input type="url" id="ik-url" placeholder="https://..." style="flex: 2; margin-top:0;" />
      </div>
      <p id="detect-msg" style="font-size: 0.85em; color: var(--palette-brand-accent); font-weight: bold; margin-top: 5px; min-height: 1.2em;"></p>
    </div>

    <div class="section">
      <label>Grid Dimensions (Optional)</label>
      <div style="display: flex; gap: 20px;">
        <div style="flex: 1;">
          <input id="gridW" type="number" placeholder="Width" />
          <span style="font-size: 0.8em; color: var(--color-text-muted);">Squares Wide</span>
        </div>
        <div style="display: flex; align-items: center; padding-top: 5px; color: var(--color-text-muted);">X</div>
        <div style="flex: 1;">
          <input id="gridH" type="number" placeholder="Height" />
          <span style="font-size: 0.8em; color: var(--color-text-muted);">Squares Tall</span>
        </div>
      </div>
    </div>

    <div class="section">
      <label for="creator">Creator Name</label>
      <input id="creator" type="text" placeholder="Who made this?" required />

      <label for="source" style="margin-top: 15px;">Creator's URL</label>
      <input id="source" type="url" placeholder="Link to Patreon, Ko-fi, or original post" />
    </div>

    <div class="section" style="background: var(--palette-bg-page-light);">
      <label class="checkbox" style="display: flex; align-items: flex-start; gap: 10px; cursor: pointer; text-transform: none; color: var(--color-text);">
        <input type="checkbox" id="freeUse" style="width: 20px; height: 20px; margin-top: 2px;" />
        <span>I confirm that this map was made available for free to the public by the creator.</span>
      </label>
    </div>

    <div class="section">
      <div id="preview-container" style="display: none; margin-bottom: 20px; text-align: center;">
        <label>Image Preview</label>
        <img id="preview" style="max-width: 100%; max-height: 400px; border-radius: 8px; border: 1px solid var(--color-border); display: block; margin: 10px auto;" />
        <a id="full-size-link" href="#" target="_blank" style="font-size: 0.9em;">View Full Size Image</a>
      </div>

      <label for="keywords">Search Keywords</label>
      <input id="keywords" type="text" placeholder="forest, cave, snow, ambush..." />
    </div>

    <button type="submit" id="submit-btn">Save Map</button>

  </form>
</div>

<script type="module">
  import { supabase } from "/assets/js/supabaseClient.js";
  import { uploadImage } from "/assets/js/imagekit-upload.js";

  const params = new URLSearchParams(window.location.search);
  const mapId = params.get("id");

  // Elements
  const fileInput = document.getElementById("ik-file");
  const urlInput = document.getElementById("ik-url");
  const gridW = document.getElementById("gridW");
  const gridH = document.getElementById("gridH");
  const previewContainer = document.getElementById("preview-container");
  const previewImg = document.getElementById("preview");
  const fullSizeLink = document.getElementById("full-size-link");
  const detectMsg = document.getElementById("detect-msg");
  const btn = document.getElementById("submit-btn");

  let currentUser = null;
  let existingImageUrl = null;

  /* -------------------------
     1. AUTH CHECK
  ------------------------- */
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    alert("You must be logged in to submit maps.");
    window.location.href = "/battlemaps-view.html";
  }
  currentUser = user;

  /* -------------------------
     2. AUTO-DETECT LOGIC
  ------------------------- */
  fileInput.addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (!file) return;

    urlInput.value = ""; // Clear URL input to avoid confusion
    
    // A. Create Preview & Load Image for Pixel Data
    const objectUrl = URL.createObjectURL(file);
    showPreview(objectUrl);
    
    // B. Analyze Filename & Pixels
    analyzeImage(file.name, objectUrl);
  });

  urlInput.addEventListener("input", (e) => {
    const url = e.target.value.trim();
    if (!url) {
      previewContainer.style.display = "none";
      detectMsg.textContent = "";
      return;
    }
    fileInput.value = ""; // Clear file input
    showPreview(url);
    
    // Analyze URL (we treat the URL string as the "filename")
    analyzeImage(url, url);
  });

  function analyzeImage(filename, src) {
    // 1. Try to find Grid Size in Filename (e.g. "Map 30x20.jpg")
    const gridMatch = filename.match(/(\d+)\s?[xX*]\s?(\d+)/);
    
    // 2. Load the image to get Pixel Dimensions
    const img = new Image();
    img.crossOrigin = "Anonymous"; // Try to avoid CORS issues with external URLs
    img.onload = () => {
      const pxW = img.naturalWidth;
      const pxH = img.naturalHeight;
      let msg = `Image Resolution: ${pxW} x ${pxH} px.`;

      if (gridMatch) {
        // SUCCESS: Found grid in filename
        gridW.value = gridMatch[1];
        gridH.value = gridMatch[2];
        msg += ` Auto-detected Grid: ${gridMatch[1]}x${gridMatch[2]}`;
        detectMsg.style.color = "var(--palette-success)";
      } else {
        // FAIL: No grid in filename, but we have pixels
        msg += ` (Could not find 'WxH' in filename)`;
        detectMsg.style.color = "var(--color-text-muted)";
      }
      detectMsg.textContent = msg;
    };
    img.src = src;
  }

  function showPreview(src) {
    previewImg.src = src;
    fullSizeLink.href = src;
    previewContainer.style.display = "block";
  }

  /* -------------------------
     3. LOAD EXISTING (EDIT MODE)
  ------------------------- */
  if (mapId) {
    document.getElementById("page-title").innerText = "Edit Battle Map";
    
    const { data, error } = await supabase
      .from("battlemaps")
      .select("*")
      .eq("id", mapId)
      .single();

    if (!error && data) {
      document.getElementById("name").value = data.name;
      gridW.value = data.grid_width || "";
      gridH.value = data.grid_height || "";
      document.getElementById("creator").value = data.creator;
      document.getElementById("source").value = data.source_url || "";
      document.getElementById("keywords").value = data.keywords || "";
      document.getElementById("freeUse").checked = data.is_free_use;

      existingImageUrl = data.image_url;
      showPreview(existingImageUrl);
    }
  }

  /* -------------------------
     4. SUBMIT HANDLER
  ------------------------- */
  document.getElementById("map-form").addEventListener("submit", async (e) => {
    e.preventDefault(); 
    btn.textContent = "Saving...";
    btn.disabled = true;

    let finalImageUrl = existingImageUrl;

    // A. Handle File Upload
    if (fileInput.files.length > 0) {
      const upload = await uploadImage();
      if (!upload) {
        alert("Image upload failed.");
        resetButton();
        return;
      }
      finalImageUrl = upload.url;
    } 
    // B. Handle URL
    else if (urlInput.value) {
      if (urlInput.value !== existingImageUrl) {
         finalImageUrl = urlInput.value;
      }
    }

    if (!finalImageUrl) {
      alert("Please upload a map image or provide a URL.");
      resetButton();
      return;
    }

    // Convert inputs to numbers (or null if empty)
    const wVal = gridW.value ? parseInt(gridW.value) : null;
    const hVal = gridH.value ? parseInt(gridH.value) : null;

    const payload = {
      name: document.getElementById("name").value,
      grid_width: wVal,
      grid_height: hVal,
      creator: document.getElementById("creator").value,
      source_url: document.getElementById("source").value,
      keywords: document.getElementById("keywords").value,
      is_free_use: document.getElementById("freeUse").checked,
      image_url: finalImageUrl,
      submitted_by: currentUser.id
    };

    let result;
    if (mapId) {
      result = await supabase.from("battlemaps").update(payload).eq("id", mapId);
    } else {
      result = await supabase.from("battlemaps").insert(payload);
    }

    if (result.error) {
      console.error(result.error);
      alert("Error saving map: " + result.error.message);
      resetButton();
    } else {
      window.location.href = "/battlemaps-view.html";
    }
  });

  function resetButton() {
    btn.textContent = "Save Map";
    btn.disabled = false;
  }
</script>