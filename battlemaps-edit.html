---
layout: default
title: Submit / Edit Battle Map
---

{% include auth-header.html %}

<section class="hero-block">
  <h1 id="page-title">Submit Battle Map</h1>
  <p>Share a map with the community. If you want to bulk load (i.e. upload a set of maps by the same creator), use the <a href="/codex/battlemaps-bulk">Bulk Upload Page</a></p>
</section>

<script src="/codex/assets/js/upload.js"></script>

<style>
  /* Restored your original CSS exactly */
  .submit-container {
    max-width: 100% !important;
    width: 100%;
    padding: 40px;
    margin: 0 auto;
  }
  
  .upload-section {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 30px;
    align-items: start;
  }
  
  .upload-left {
    display: flex;
    flex-direction: column;
  }
  
  .upload-right {
    display: flex;
    justify-content: center;
    align-items: center;
  }
  
  @media (max-width: 768px) {
    .upload-section {
      grid-template-columns: 1fr;
    }
  }
</style>

<div class="submit-container">
  <div class="upload-section">
    <div class="upload-left">
      <div style="margin-bottom: 20px;">
        <label for="mapName">Map Name</label>
        <input id="mapName" type="text" placeholder="e.g. Ruined Keep" required style="width: 100%; padding: 10px;" />
      </div>

      <div style="display: flex; gap: 20px; margin-bottom: 20px;">
        <div style="flex: 1;">
          <label for="gridW">Grid Width (cells)</label>
          <input id="gridW" type="number" placeholder="Optional" style="width: 100%; padding: 10px;" />
        </div>
        <div style="flex: 1;">
          <label for="gridH">Grid Height (cells)</label>
          <input id="gridH" type="number" placeholder="Optional" style="width: 100%; padding: 10px;" />
        </div>
      </div>

      <div style="margin-bottom: 20px;">
        <label for="creator">Creator Name</label>
        <input id="creator" type="text" placeholder="Who made this?" required style="width: 100%; padding: 10px;" />
      </div>

      <div style="margin-bottom: 20px;">
        <label for="source">Creator's URL (Source)</label>
        <input id="source" type="url" placeholder="Patreon link, etc." style="width: 100%; padding: 10px;" />
      </div>

      <div style="margin-bottom: 20px;">
        <label for="keywords">Search Keywords (Auto-generated)</label>
        <input id="keywords" type="text" placeholder="Uploading image will generate keywords..." style="width: 100%; padding: 10px;" />
      </div>

      <label class="checkbox" style="display: flex; align-items: flex-start; gap: 10px; cursor: pointer; color: var(--color-text);">
        <input type="checkbox" id="freeUse" style="width: 20px; height: 20px;" required />
        <span>I confirm this map was made available for free by the creator.</span>
      </label>

      <div style="margin-top: 30px;">
        <button id="save-btn" class="button primary" style="width: 100%; padding: 15px;">Save Map</button>
      </div>
    </div>

    <div class="upload-right">
      <div id="upload-widget-container" style="width: 100%; text-align: center;">
        <p id="upload-status" style="margin-top: 10px; font-weight: bold;">Loading upload tool...</p>
        
        <div id="image-preview-container" style="margin-top: 20px; display: none;">
          <img id="image-preview" src="" style="max-width: 100%; border-radius: 8px; border: 1px solid var(--color-border);" />
        </div>
        
        <input type="hidden" id="image-url" />
        <input type="hidden" id="thumb-url" />
      </div>
    </div>
  </div>
</div>

<script type="module">
  import { supabase } from "../assets/js/supabaseClient.js";
  import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

  // --- AI CONFIGURATION ---
  const genAI = new GoogleGenerativeAI("AIzaSyAnfiXcRrAUwX5_ogCYYygycRD0uZVKbw8");
  const aiModel = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });

  // --- DOM ELEMENTS & VARIABLES ---
  const urlParams = new URLSearchParams(window.location.search);
  const mapId = urlParams.get("id");

  const pageTitle = document.getElementById("page-title");
  const nameInput = document.getElementById("mapName");
  const gridW = document.getElementById("gridW");
  const gridH = document.getElementById("gridH");
  const uploadStatus = document.getElementById("upload-status");
  const saveBtn = document.getElementById("save-btn");

  let currentUser = null;
  let isApprovedSubmitter = false;
  let existingImageUrl = null;
  let existingThumbUrl = null;

  // --- HELPER: Convert Blob to Base64 (Required for AI) ---
  async function blobToBase64(blob) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onloadend = () => resolve(reader.result.split(',')[1]);
      reader.onerror = reject;
      reader.readAsDataURL(blob);
    });
  }

  // --- FUNCTION: Run AI Tagging ---
  async function autoTagMap(imageUrl) {
    try {
      const prompt = "Act as a TTRPG expert. Look at this battlemap and provide 8-10 descriptive search keywords (e.g., forest, dungeon, night, ruins, river). Return ONLY the keywords separated by commas.";
      
      const resp = await fetch(imageUrl);
      const blob = await resp.blob();
      const base64Data = await blobToBase64(blob);

      const result = await aiModel.generateContent([
        prompt,
        { inlineData: { data: base64Data, mimeType: "image/jpeg" } }
      ]);

      const keywords = result.response.text();
      const keyInput = document.getElementById("keywords");
      if(keyInput) {
        keyInput.value = keywords.toLowerCase().trim().replace(/\*/g, "");
      }
      uploadStatus.textContent = "✓ Image uploaded + AI Keywords Generated";
      uploadStatus.style.color = "var(--palette-success)";
      
    } catch (err) {
      console.error("AI Tagging failed:", err);
      uploadStatus.textContent = "✓ Image uploaded (AI analysis skipped)";
    }
  }

  // --- EVENT LISTENER: Trigger AI after Upload ---
  window.addEventListener('image-upload-complete', async (event) => {
    const fullUrl = event.detail.url;
    const thumbUrl = event.detail.thumbUrl;
    
    document.getElementById('image-url').value = fullUrl;
    document.getElementById('thumb-url').value = thumbUrl;
    
    const preview = document.getElementById('image-preview');
    preview.src = thumbUrl;
    document.getElementById('image-preview-container').style.display = 'block';
    
    uploadStatus.textContent = "✓ Image uploaded. AI is analyzing...";
    
    // Call the AI function here
    await autoTagMap(fullUrl);
  });

  // --- AUTH CHECK ---
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    alert("Please log in.");
    window.location.href = "/codex/battlemaps-view";
  }
  currentUser = user;

  const { data: profile } = await supabase.from("discord_users").select("approved_map_submitter").eq("user_id", user.id).single();
  if (profile && profile.approved_map_submitter) {
    isApprovedSubmitter = true;
  }

  // --- LOAD EXISTING MAP (IF EDITING) ---
  if (mapId) {
    pageTitle.textContent = "Edit Battle Map";
    const { data: map } = await supabase.from("battlemaps").select("*").eq("id", mapId).single();
    if (map) {
      nameInput.value = map.name;
      gridW.value = map.grid_width;
      gridH.value = map.grid_height;
      document.getElementById("creator").value = map.creator;
      document.getElementById("source").value = map.source_url;
      document.getElementById("keywords").value = map.keywords;
      document.getElementById("freeUse").checked = map.is_free_use;
      existingImageUrl = map.image_url;
      existingThumbUrl = map.thumbnail_url;
      
      const preview = document.getElementById('image-preview');
      preview.src = map.thumbnail_url;
      document.getElementById('image-preview-container').style.display = 'block';
      uploadStatus.textContent = "Current image loaded. Upload a new one to replace it.";
    }
  }

  // --- SAVE BUTTON HANDLER ---
  saveBtn.onclick = async () => {
    if (!nameInput.value || !document.getElementById("creator").value || !document.getElementById("freeUse").checked) {
      alert("Please fill in required fields.");
      return;
    }

    saveBtn.textContent = "Saving...";
    saveBtn.disabled = true;

    const finalImageUrl = document.getElementById('image-url').value || existingImageUrl;
    const finalThumbUrl = document.getElementById('thumb-url').value || existingThumbUrl;

    const payload = {
      name: nameInput.value,
      grid_width: gridW.value ? parseInt(gridW.value) : null,
      grid_height: gridH.value ? parseInt(gridH.value) : null,
      creator: document.getElementById("creator").value,
      source_url: document.getElementById("source").value,
      keywords: document.getElementById("keywords").value,
      is_free_use: document.getElementById("freeUse").checked,
      image_url: finalImageUrl,
      thumbnail_url: finalThumbUrl,
      is_approved: isApprovedSubmitter
    };

    let result;
    if (mapId) {
      result = await supabase.from("battlemaps").update(payload).eq("id", parseInt(mapId));
    } else {
      payload.submitted_by = currentUser.id;
      result = await supabase.from("battlemaps").insert(payload);
    }

    if (result.error) {
      console.error("Supabase Error:", result.error);
      alert("Error saving map: " + result.error.message);
      saveBtn.disabled = false;
      saveBtn.textContent = "Save Map";
    } else {
      window.location.href = "/codex/battlemaps-view";
    }
  };
</script>