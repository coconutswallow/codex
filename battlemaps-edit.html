---
layout: default
title: Submit / Edit Battle Map
---

{% include auth-header.html %}

<section class="hero-block">
  <h1 id="page-title">Submit Battle Map</h1>
  <p>Share a map with the community.  If you want to bulk load (i.e. upload a set of maps by the same creator, there is a <a href="/codex/battlemaps-bulk">Bulk Upload Page</a></p>
</section>

<script src="/codex/assets/js/upload.js"></script>

<style>
  /* Full width layout */
  .submit-container {
    max-width: 100% !important;
    width: 100%;
    padding: 40px;
    margin: 0 auto;
  }
  
  /* Two column layout for upload section */
  .upload-section {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 30px;
    align-items: start;
  }
  
  .upload-left {
    display: flex;
    flex-direction: column;
  }
  
  .upload-right {
    display: flex;
    justify-content: center;
    align-items: center;
  }
  
  @media (max-width: 768px) {
    .upload-section {
      grid-template-columns: 1fr;
    }
  }
</style>

<div class="submit-container">
  
  <form id="map-form" class="controls">
    
    <div class="section">
      <label for="name">Map Name</label>
      <input id="name" type="text" placeholder="e.g. Forest Ambush" required />
    </div>

    <div class="section">
      <label for="creator">Creator Name</label>
      <input id="creator" type="text" placeholder="Who made this?" required />

      <label for="source" style="margin-top: 15px;">Creator's URL</label>
      <input id="source" type="url" placeholder="Link to Patreon, Ko-fi, or original post" />
    </div>

    <div class="section" style="background: var(--palette-bg-page-light);">
      <label class="checkbox" style="display: flex; align-items: flex-start; gap: 10px; cursor: pointer; text-transform: none; color: var(--color-text);">
        <input type="checkbox" id="freeUse" style="width: 20px; height: 20px; margin-top: 2px;" required />
        <span><strong>Required:</strong> I confirm that this map was made available for free to the public by the creator.</span>
      </label>
    </div>

    <div class="section">
      <label>Map File</label>
      
      <div class="upload-section">
        <div class="upload-left">
          <p style="font-size: 0.85em; color: var(--color-text-muted); margin-top:0;">
            Click to upload an image file.
          </p>
          
          <button type="button" class="trigger-upload" style="padding: 10px 20px; cursor: pointer; width: fit-content;">
            ðŸ“¤ Upload Image
          </button>
          
          <div id="upload-status" style="margin-top: 10px; font-size: 0.9em; color: var(--color-text-muted);"></div>
          
          <input type="hidden" id="image-id" />
          <input type="hidden" id="image-url" />
          <input type="hidden" id="thumb-url" />
        </div>
        
        <div class="upload-right">
          <div id="preview-container" style="display: none; text-align: center; width: 100%;">
            <label>Image Preview</label>
            <img id="preview" style="max-width: 100%; max-height: 400px; border-radius: 8px; border: 1px solid var(--color-border); display: block; margin: 10px auto;" />
            <a id="full-size-link" href="#" target="_blank" style="font-size: 0.9em;">View Full Size Image</a>
          </div>
        </div>
      </div>
    </div>

    <div class="section">
      <label>Image Dimensions</label>
      <p id="detect-msg" style="font-size: 0.85em; color: var(--palette-brand-accent); font-weight: bold; margin-top: 5px; min-height: 1.2em;"></p>
      <div style="display: flex; gap: 20px;">
        <div style="flex: 1;">
          <input id="gridW" type="number" placeholder="Width" readonly style="background: var(--palette-bg-page-light);" />
          <span style="font-size: 0.8em; color: var(--color-text-muted);">Width (px)</span>
        </div>
        <div style="display: flex; align-items: center; padding-top: 5px; color: var(--color-text-muted);">X</div>
        <div style="flex: 1;">
          <input id="gridH" type="number" placeholder="Height" readonly style="background: var(--palette-bg-page-light);" />
          <span style="font-size: 0.8em; color: var(--color-text-muted);">Height (px)</span>
        </div>
      </div>
    </div>

    <div class="section">
      <label for="keywords">Search Keywords</label>
      <input id="keywords" type="text" placeholder="forest, cave, snow, ambush..." />
    </div>

    <button type="submit" id="submit-btn">Save Map</button>

  </form>
</div>

<script type="module">
  import { supabase } from "../assets/js/supabaseClient.js";
  import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

  // --- 1. AI CONFIGURATION ---
  // Replace with your VALID API Key.
  const genAI = new GoogleGenerativeAI("AIzaSyDthqoHCBkJs2oIQi2bgCrhfLo2WizSomo");
  
  // FIX 1: Use specific model version 'gemini-1.5-flash-001' to avoid 404 errors
  const aiModel = genAI.getGenerativeModel({ model: "gemini-1.5-flash-001" });

  // --- 2. HELPER FUNCTION: Blob to Base64 ---
  async function blobToBase64(blob) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onloadend = () => resolve(reader.result.split(',')[1]);
      reader.onerror = reject;
      reader.readAsDataURL(blob);
    });
  }

  // --- 3. MAIN AI TAGGING FUNCTION ---
  async function autoTagMap(imageUrl) {
    try {
      const prompt = "Act as a TTRPG expert. Look at this battlemap and provide 8-10 descriptive search keywords (e.g., forest, dungeon, night, ruins, river). Return ONLY the keywords separated by commas.";
      
      const resp = await fetch(imageUrl, { mode: 'cors' });
      if (!resp.ok) throw new Error("Could not fetch image for AI");
      
      const blob = await resp.blob();
      const base64Data = await blobToBase64(blob); 

      const result = await aiModel.generateContent([
        prompt,
        { inlineData: { data: base64Data, mimeType: "image/jpeg" } }
      ]);

      const keywords = result.response.text();
      
      // Update UI
      const keywordsInput = document.getElementById("keywords");
      if (keywordsInput) {
          keywordsInput.value = keywords.toLowerCase().trim().replace(/\*/g, ""); 
      }
      
      const statusEl = document.getElementById("upload-status");
      statusEl.textContent = "âœ“ Image uploaded + AI Keywords Generated";
      statusEl.style.color = "var(--palette-success)";
      
    } catch (err) {
      console.error("AI Tagging failed:", err);
      const statusEl = document.getElementById("upload-status");
      statusEl.textContent = "âœ“ Image uploaded (AI Tagging failed)";
    }
  }

  // --- 4. PAGE VARIABLES & LOGIC ---
  const params = new URLSearchParams(window.location.search);
  const mapId = params.get("id");

  const gridW = document.getElementById("gridW");
  const gridH = document.getElementById("gridH");
  const previewContainer = document.getElementById("preview-container");
  const previewImg = document.getElementById("preview");
  const fullSizeLink = document.getElementById("full-size-link");
  const detectMsg = document.getElementById("detect-msg");
  const uploadStatus = document.getElementById("upload-status");
  const btn = document.getElementById("submit-btn");
  const nameInput = document.getElementById("name");

  let currentUser = null;
  let existingImageUrl = null;
  let existingThumbUrl = null;

  // --- AUTH CHECK ---
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    alert("You must be logged in to submit maps.");
    window.location.href = "/codex/battlemaps-view";
  }
  currentUser = user;

  let isApprovedSubmitter = false;
  const { data: profile } = await supabase
    .from("discord_users")
    .select("approved_map_submitter")
    .eq("user_id", currentUser.id)
    .single();

  if (profile && profile.approved_map_submitter === true) {
    isApprovedSubmitter = true;
  }

  // --- EVENT: UPLOAD COMPLETE ---
  window.addEventListener('image-upload-complete', async (event) => {
    console.log("Upload complete event:", event.detail);
    
    const dbId = event.detail.id;
    const thumbUrl = event.detail.thumb;
    const fullUrl = event.detail.url;

    if (fullUrl) {
      uploadStatus.textContent = "âœ“ Image uploaded. AI is analyzing...";
      // We don't await here so the UI updates immediately
      autoTagMap(fullUrl);
    }
    
    // Auto-fill name if blank
    if (!nameInput.value.trim() && dbId) {
      try {
        // FIX 2: Use .maybeSingle() instead of .single() to prevent 406 Error
        const { data: imgData } = await supabase
          .from('freehost_images')
          .select('original_filename')
          .eq('id', dbId)
          .maybeSingle();

        if (imgData && imgData.original_filename) {
          const cleanName = imgData.original_filename.replace(/\.[^/.]+$/, "");
          nameInput.value = cleanName;
        }
      } catch (err) {
        console.warn("Could not auto-fetch filename:", err);
      }
    }

    if (!fullUrl) {
      console.error("No full URL in event data - using thumb as fallback");
      document.getElementById('image-id').value = dbId;
      document.getElementById('thumb-url').value = thumbUrl;
      document.getElementById('image-url').value = thumbUrl;
      showPreview(thumbUrl, thumbUrl);
      analyzeImageFromUrl(thumbUrl);
      uploadStatus.style.color = "orange";
      uploadStatus.textContent = "âœ“ Uploaded (using thumbnail as image)";
      return;
    }
    
    document.getElementById('image-id').value = dbId;
    document.getElementById('thumb-url').value = thumbUrl;
    document.getElementById('image-url').value = fullUrl;
    
    showPreview(thumbUrl, fullUrl);
    analyzeImageFromUrl(fullUrl);
    
    uploadStatus.style.color = "var(--palette-success)";
    uploadStatus.textContent = "âœ“ Image uploaded successfully";
  });

  // --- HELPER: ANALYZE DIMENSIONS ---
  async function analyzeImageFromUrl(url) {
    const img = new Image();
    img.crossOrigin = "Anonymous";
    img.onload = () => {
      const pxW = img.naturalWidth;
      const pxH = img.naturalHeight;
      gridW.value = pxW;
      gridH.value = pxH;
      let msg = `Image Resolution: ${pxW} x ${pxH} px`;
      detectMsg.style.color = "var(--palette-success)";
      detectMsg.textContent = msg;
    };
    img.onerror = () => {
      detectMsg.textContent = "Image loaded but couldn't analyze dimensions";
      detectMsg.style.color = "var(--color-text-muted)";
    };
    img.src = url;
  }

  function showPreview(thumbSrc, fullSrc) {
    previewImg.src = thumbSrc;
    fullSizeLink.href = fullSrc;
    previewContainer.style.display = "block";
  }

  // --- EDIT MODE LOADING ---
  if (mapId) {
    document.getElementById("page-title").innerText = "Edit Battle Map";
    const { data, error } = await supabase.from("battlemaps").select("*").eq("id", mapId).single();

    if (!error && data) {
      nameInput.value = data.name;
      gridW.value = data.grid_width || "";
      gridH.value = data.grid_height || "";
      document.getElementById("creator").value = data.creator;
      document.getElementById("source").value = data.source_url || "";
      document.getElementById("keywords").value = data.keywords || "";
      document.getElementById("freeUse").checked = data.is_free_use;

      existingImageUrl = data.image_url;
      existingThumbUrl = data.thumbnail_url;
      
      if (existingImageUrl) {
        document.getElementById('image-url').value = existingImageUrl;
        document.getElementById('thumb-url').value = existingThumbUrl || existingImageUrl;
        showPreview(existingThumbUrl || existingImageUrl, existingImageUrl);
        uploadStatus.textContent = "Using existing image";
      }
    }
  }

  // --- SUBMIT HANDLER ---
  document.getElementById("map-form").addEventListener("submit", async (e) => {
    e.preventDefault(); 
    
    if (!document.getElementById("freeUse").checked) {
      alert("Please confirm that this map was made available for free to the public.");
      return;
    }
    
    btn.textContent = "Saving...";
    btn.disabled = true;

    const finalImageUrl = document.getElementById('image-url').value || existingImageUrl;
    const finalThumbUrl = document.getElementById('thumb-url').value || existingThumbUrl;

    const payload = {
      name: nameInput.value,
      grid_width: gridW.value ? parseInt(gridW.value) : null,
      grid_height: gridH.value ? parseInt(gridH.value) : null,
      creator: document.getElementById("creator").value,
      source_url: document.getElementById("source").value,
      keywords: document.getElementById("keywords").value,
      is_free_use: document.getElementById("freeUse").checked,
      image_url: finalImageUrl,
      thumbnail_url: finalThumbUrl,
      is_approved: isApprovedSubmitter
    };

    let result;
    if (mapId) {
      result = await supabase.from("battlemaps").update(payload).eq("id", parseInt(mapId));
    } else {
      payload.submitted_by = currentUser.id;
      result = await supabase.from("battlemaps").insert(payload);
    }

    if (result.error) {
      console.error("Supabase Error:", result.error);
      alert("Error saving map: " + result.error.message);
      resetButton();
    } else {
      window.location.href = "/codex/battlemaps-view";
    }
  });

  function resetButton() {
    btn.textContent = "Save Map";
    btn.disabled = false;
  }
</script>