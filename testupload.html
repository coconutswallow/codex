<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Freeimage.host Plugin Upload</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 2rem auto; padding: 0 1rem; }
        .container { border: 1px solid #ccc; padding: 2rem; border-radius: 8px; background: #f9f9f9; }
        
        /* Style the hidden target div so we don't see the raw code it dumps */
        #hidden-target { display: none; }
        
        /* Results area */
        #results { margin-top: 2rem; display: none; }
        .result-item { margin-bottom: 1.5rem; padding: 1rem; background: #fff; border: 1px solid #ddd; border-radius: 4px; }
        .url-box { background: #eee; padding: 0.5rem; word-break: break-all; font-family: monospace; margin-top: 0.5rem; }
        img { max-width: 100%; height: auto; margin-top: 10px; border: 1px solid #ddd; }
    </style>
</head>
<body>

<div class="container">
    <h1>Plugin Upload Test</h1>
    <p>Click the button below to open the secure upload window.</p>

    <script async 
            src="//freeimage.host/sdk/pup.js" 
            data-url="https://freeimage.host/upload" 
            data-auto-insert="html-embed-medium" 
            data-target="#hidden-target">
    </script>
    
    <div id="hidden-target"></div>

    <div id="results">
        <h2>Upload Result</h2>
        <div class="result-item">
            <strong>Full Image:</strong>
            <div id="urlDisplay" class="url-box"></div>
            <img id="imagePreview" src="" alt="Preview">
        </div>
    </div>
</div>

<script>
    // We use a MutationObserver to "watch" the hidden-target div.
    // When the plugin inserts the HTML code, this triggers.
    const targetNode = document.getElementById('hidden-target');
    const resultsDiv = document.getElementById('results');
    const urlDisplay = document.getElementById('urlDisplay');
    const imagePreview = document.getElementById('imagePreview');

    const config = { childList: true, subtree: true, characterData: true };

    const callback = function(mutationsList, observer) {
        for(const mutation of mutationsList) {
            // Check if content was added to the target div
            if (targetNode.innerHTML.trim() !== "") {
                
                // The plugin dumps raw HTML like: <a href="..."><img src="..."></a>
                // We parse that string to extract the real URLs.
                const parser = new DOMParser();
                const doc = parser.parseFromString(targetNode.textContent || targetNode.innerHTML, 'text/html');
                const imgTag = doc.querySelector('img');
                const aTag = doc.querySelector('a');

                if (imgTag) {
                    const src = imgTag.src; // Thumbnail or Medium URL
                    const fullLink = aTag ? aTag.href : src; // Full URL

                    // Update our nice display
                    imagePreview.src = src;
                    urlDisplay.textContent = fullLink;
                    resultsDiv.style.display = 'block';

                    // Clear the hidden target so it's ready for the next one
                    // (Disconnect briefly to avoid infinite loop if we cleared it inside)
                    observer.disconnect();
                    targetNode.innerHTML = ""; 
                    observer.observe(targetNode, config); 
                }
            }
        }
    };

    const observer = new MutationObserver(callback);
    observer.observe(targetNode, config);
</script>

</body>
</html>