---
layout: default
---

{% include auth-header.html %}

<h2>Submit Battlemap</h2>

<div>
  <input id="ik-file" type="file" accept="image/*" />
  <input id="ik-url" type="url" placeholder="Or paste image URL" />
</div>

<form id="map-form">
  <input id="name" placeholder="Map name" required />
  <input id="gridW" type="number" placeholder="Grid width" required />
  <input id="gridH" type="number" placeholder="Grid height" required />
  <input id="cell" type="number" placeholder="Cell size (px)" />

  <input id="creator" placeholder="Creator" required />
  <input id="source" placeholder="Source URL" />
  <input id="keywords" placeholder="Keywords" />

  <label>
    <input type="checkbox" id="freeUse" />
    Free to use
  </label>

  <button type="submit">Submit</button>
</form>

<script type="module">
  import { supabase } from "/assets/js/supabaseClient.js";
  import { uploadImage } from "/assets/js/imagekit-upload.js";

  document.getElementById("map-form").addEventListener("submit", async (e) => {
    e.preventDefault();

    const { data: { user } } = await supabase.auth.getUser();
    if (!user) {
      alert("You must be logged in.");
      return;
    }

    const image = await uploadImage();
    if (!image) return;

    const payload = {
      name: name.value,
      grid_width: +gridW.value,
      grid_height: +gridH.value,
      cell_size_px: +cell.value || null,
      keywords: keywords.value,
      creator: creator.value,
      source_url: source.value,
      is_free_use: freeUse.checked,
      submitted_by: user.id
    };

    const { error } = await supabase
      .from("battlemaps")
      .insert(payload);

    if (error) {
      console.error(error);
      alert("Failed to save map");
    } else {
      location.href = "/maps.html";
    }
  });
</script>
