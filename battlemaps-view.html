---
layout: default
title: Battle Maps
---

{% include auth-header.html %}

<section class="hero-block">
  <h1>Curated Battle Maps</h1>
  <p>
    High-quality battle maps shared by the community.
    Optimized for fast browsing and Avrae use.
  </p>

  <p id="map-count-display">Loading maps…</p>
</section>

<div class="map-search-wrapper">
  <input
    type="text"
    id="mapSearchInput"
    placeholder="Search by name, creator, or keyword…"
  />

  <a href="battlemaps-edit" class="tool-btn">
    + Submit Map
  </a>
</div>

<div id="gallery-container" class="map-gallery"></div>

<button
  id="load-more-btn"
  class="tool-btn"
  style="display:none; margin:20px auto;"
>
  Load More
</button>

<script type="module">
  import { supabase } from "../assets/js/supabaseClient.js";

  const PAGE_SIZE = 24;

  let currentPage = 0;
  let currentSearch = "";
  let loading = false;
  let reachedEnd = false;

  const gallery = document.getElementById("gallery-container");
  const countDisplay = document.getElementById("map-count-display");
  const loadMoreBtn = document.getElementById("load-more-btn");

  /* -----------------------------
     INITIAL LOAD
  ----------------------------- */
  document.addEventListener("DOMContentLoaded", () => {
    resetGallery();

    const search = document.getElementById("mapSearchInput");
    let timeout = null;

    search.addEventListener("input", e => {
      clearTimeout(timeout);
      timeout = setTimeout(() => {
        currentSearch = e.target.value.trim();
        resetGallery();
      }, 400);
    });

    loadMoreBtn.onclick = fetchMaps;
  });

  /* -----------------------------
     DATA FETCHING
  ----------------------------- */
  async function fetchMaps() {
    if (loading || reachedEnd) return;
    loading = true;

    loadMoreBtn.textContent = "Loading…";

    let query = supabase
      .from("battlemaps")
      .select("*", { count: "exact" })
      .eq("is_approved", true)
      .order("created_at", { ascending: false })
      .range(
        currentPage * PAGE_SIZE,
        currentPage * PAGE_SIZE + PAGE_SIZE - 1
      );

    if (currentSearch) {
      const term = `%${currentSearch}%`;
      query = query.or(
        `name.ilike.${term},creator.ilike.${term},keywords.ilike.${term}`
      );
    }

    const { data, error, count } = await query;

    if (error) {
      console.error(error);
      return;
    }

    if (currentPage === 0) {
      countDisplay.textContent =
        count === 1
          ? "1 map available"
          : `${count.toLocaleString()} maps available`;
    }

    if (!data || data.length === 0) {
      reachedEnd = true;
      loadMoreBtn.style.display = "none";
      return;
    }

    renderMaps(data);

    if (data.length < PAGE_SIZE) {
      reachedEnd = true;
      loadMoreBtn.style.display = "none";
    } else {
      loadMoreBtn.style.display = "block";
      loadMoreBtn.textContent = "Load More";
    }

    currentPage++;
    loading = false;
  }

  function resetGallery() {
    gallery.innerHTML = "";
    currentPage = 0;
    reachedEnd = false;
    fetchMaps();
  }

  /* -----------------------------
     RENDERING
  ----------------------------- */
  function renderMaps(maps) {
    maps.forEach(map => {
      const thumb = `${map.image_url}?tr=w-420`;

      const card = document.createElement("div");
      card.className = "map-card";

      card.innerHTML = `
        <a href="${map.image_url}" target="_blank" class="map-thumb">
          <img
            src="${thumb}"
            loading="lazy"
            alt="${map.name}"
          />
        </a>

        <div class="map-info">
          <h3>${map.name}</h3>

          <p>
            <strong>Creator:</strong>
            ${map.source_url
              ? `<a href="${map.source_url}" target="_blank">${map.creator}</a>`
              : map.creator}
          </p>

          <p>
            <strong>Size:</strong>
            ${map.grid_width} × ${map.grid_height}
          </p>

          ${
            map.avrae_cmd
              ? `<div class="avrae">
                  <code>${map.avrae_cmd}</code>
                  <button class="copy-btn">Copy</button>
                </div>`
              : ""
          }

          ${
            map.keywords
              ? `<div class="tags">${map.keywords}</div>`
              : ""
          }
        </div>
      `;

      gallery.appendChild(card);
    });

    wireCopyButtons();
  }

  function wireCopyButtons() {
    document.querySelectorAll(".copy-btn").forEach(btn => {
      btn.onclick = () => {
        const code = btn.previousElementSibling.textContent;
        navigator.clipboard.writeText(code);
        btn.textContent = "Copied!";
        setTimeout(() => (btn.textContent = "Copy"), 1200);
      };
    });
  }
</script>
