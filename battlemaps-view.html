---
layout: default
title: Battle Maps
---

{% include auth-header.html %}

<section class="hero-block">
  <h1>Curated Battle Maps</h1>
  <p>
    Curated battlemaps submitted by the community. Browse, search, and download.  All maps uploaded are free to use by the original creator, and each image is credited to the creator with links to the creator's page (click on creator name to link to creator's page).
    
  </p>

  <p id="map-count-display">Loading maps‚Ä¶</p>
</section>

<div class="map-search-wrapper">
  <input
    type="text"
    id="mapSearchInput"
    placeholder="Search by name, creator, or keyword‚Ä¶"
  />

  <a href="battlemaps-edit" class="tool-btn">
    + Submit Map
  </a>
</div>

<div id="gallery-container" class="map-gallery"></div>

<button
  id="load-more-btn"
  class="tool-btn"
  style="display:none; margin:20px auto;"
>
  Load More
</button>

<script type="module">
  import { supabase } from "../assets/js/supabaseClient.js";

  const PAGE_SIZE = 24;

  let currentPage = 0;
  let currentSearch = "";
  let loading = false;
  let reachedEnd = false;
  let currentUser = null;

  const gallery = document.getElementById("gallery-container");
  const countDisplay = document.getElementById("map-count-display");
  const loadMoreBtn = document.getElementById("load-more-btn");

  /* -----------------------------
     GET CURRENT USER
  ----------------------------- */
  async function getCurrentUser() {
    const { data: { user } } = await supabase.auth.getUser();
    currentUser = user;
  }

  /* -----------------------------
     INITIAL LOAD
  ----------------------------- */
  document.addEventListener("DOMContentLoaded", async () => {
    await getCurrentUser();
    resetGallery();

    const search = document.getElementById("mapSearchInput");
    let timeout = null;

    search.addEventListener("input", e => {
      clearTimeout(timeout);
      timeout = setTimeout(() => {
        currentSearch = e.target.value.trim();
        resetGallery();
      }, 400);
    });

    loadMoreBtn.onclick = fetchMaps;
  });

  /* -----------------------------
     DATA FETCHING
  ----------------------------- */
  async function fetchMaps() {
    if (loading || reachedEnd) return;
    loading = true;

    loadMoreBtn.textContent = "Loading‚Ä¶";

    let query = supabase
      .from("battlemaps")
      .select("*", { count: "exact" })
      .eq("is_approved", true)
      .order("created_at", { ascending: false })
      .range(
        currentPage * PAGE_SIZE,
        currentPage * PAGE_SIZE + PAGE_SIZE - 1
      );

    if (currentSearch) {
      const term = `%${currentSearch}%`;
      query = query.or(
        `name.ilike.${term},creator.ilike.${term},keywords.ilike.${term}`
      );
    }

    const { data, error, count } = await query;

    if (error) {
      console.error(error);
      return;
    }

    if (currentPage === 0) {
      countDisplay.textContent =
        count === 1
          ? "1 map available"
          : `${count.toLocaleString()} maps available`;
    }

    if (!data || data.length === 0) {
      reachedEnd = true;
      loadMoreBtn.style.display = "none";
      return;
    }

    renderMaps(data);

    if (data.length < PAGE_SIZE) {
      reachedEnd = true;
      loadMoreBtn.style.display = "none";
    } else {
      loadMoreBtn.style.display = "block";
      loadMoreBtn.textContent = "Load More";
    }

    currentPage++;
    loading = false;
  }

  function resetGallery() {
    gallery.innerHTML = "";
    currentPage = 0;
    reachedEnd = false;
    fetchMaps();
  }

  /* -----------------------------
     RENDERING
  ----------------------------- */
  function renderMaps(maps) {
    maps.forEach(map => {
      // Use thumbnail for display, full image for link
      const thumb = map.thumbnail_url || map.image_url;
      const fullImage = map.image_url;
      const isOwner = currentUser && currentUser.id === map.submitted_by;

      const card = document.createElement("div");
      card.className = "map-card";

      card.innerHTML = `
        <div class="map-thumb">
          <img
            src="${thumb}"
            loading="lazy"
            alt="${map.name}"
          />
        </div>

        <div class="map-info">
          <h3>${map.name}</h3>

          <p>
            <strong>Creator:</strong>
            ${map.source_url
              ? `<a href="${map.source_url}" target="_blank">${map.creator}</a>`
              : map.creator}
          </p>

          <p>
            <strong>Dimensions:</strong>
            ${map.grid_width && map.grid_height 
              ? `${map.grid_width} √ó ${map.grid_height} px`
              : 'Not specified'}
          </p>

          ${
            map.keywords
              ? `<div class="tags" style="font-size: 0.85em; color: var(--color-text-muted); margin-top: 5px;">${map.keywords}</div>`
              : ""
          }

          <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
            <a href="${fullImage}" target="_blank" class="tool-btn" style="flex: 1; text-align: center; padding: 8px 12px; text-decoration: none;">
              üñºÔ∏è Full Image
            </a>
            ${isOwner 
              ? `<a href="battlemaps-edit?id=${map.id}" class="tool-btn" style="flex: 1; text-align: center; padding: 8px 12px; text-decoration: none; background: var(--palette-accent);">
                  ‚úèÔ∏è Edit
                </a>`
              : ''
            }
          </div>
        </div>
      `;

      gallery.appendChild(card);
    });
  }
</script>