<script>
  // --- 1. CONFIGURATION ---
  // üî¥ PASTE YOUR KEYS HERE üî¥
  const SUPABASE_URL = 'https://kcbvryvmcbfpsibxthhn.supabase.co';
  const SUPABASE_KEY = 'sb_publishable_cGXFwDjzWIWCdRRmcMZIcg_vnp1Azyo'; 
  const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // --- 2. APP STATE ---
  const img = document.getElementById('preview-img');
  const overlay = document.getElementById('grid-overlay');
  const cmdOutput = document.getElementById('cmdOutput');
  const statusMsg = document.getElementById('statusMsg');

  // --- 3. LOAD IMAGE ---
  function loadImage() {
    const url = document.getElementById('imgUrl').value;
    if(!url) return;

    console.log("Attempting to load:", url); // Debug log
    statusMsg.innerText = "Loading...";
    statusMsg.style.color = "blue";

    // Remove the "Map Preview" text if it exists
    const placeholder = document.querySelector('.map-viewer p');
    if(placeholder) placeholder.style.display = 'none';

    // Force the image to attempt loading
    img.removeAttribute('src'); // Reset
    img.style.display = 'block'; // Ensure it is visible
    img.src = url; // Set new source
  }

  // Listen for the load event
  img.onload = function() {
    console.log("Image loaded successfully");
    statusMsg.innerText = "";
    updateGrid(); 
  };

  // Listen for errors
  img.onerror = function() {
    console.error("Image failed to load");
    statusMsg.innerText = "‚ùå Error: content blocked or invalid link. Ensure URL ends in .jpg/.png";
    statusMsg.style.color = "red";
  };

  // --- 4. UPDATE GRID VISUALS ---
  function updateGrid() {
    // Sync Sliders and Number boxes
    const w = document.getElementById('gridW_num').value = document.getElementById('gridW_slider').value;
    const h = document.getElementById('gridH_num').value = document.getElementById('gridH_slider').value;
    const ppi = document.getElementById('ppi_num').value = document.getElementById('ppi_slider').value;

    // Calculate Dimensions
    const totalWidth = w * ppi;
    const totalHeight = h * ppi;

    // Apply to Overlay
    overlay.style.width = totalWidth + 'px';
    overlay.style.height = totalHeight + 'px';
    overlay.style.backgroundSize = `${ppi}px ${ppi}px`; 

    // Force Image to match the grid width 
    if(img.src) {
        img.style.width = totalWidth + 'px';
        img.style.height = totalHeight + 'px';
    }

    // Update Command String
    const url = document.getElementById('imgUrl').value || "[URL]";
    const cmd = `!map -bg ${url} -w ${w} -h ${h} --options c${ppi}`;
    cmdOutput.innerText = cmd;
  }

  // --- 5. SUBMIT TO SUPABASE ---
  async function submitMap() {
    const btn = document.getElementById('submit-btn');
    
    // Validation
    if (!document.getElementById('tosCheck').checked) return alert("Please confirm the map is free to use.");
    if (!document.getElementById('imgUrl').value) return alert("Image URL is required.");
    
    // Check if image actually loaded (naturalWidth is 0 if broken)
    if (img.naturalWidth === 0) return alert("Please load a valid image first.");

    btn.disabled = true;
    btn.innerText = "Sending...";

    const payload = {
      name: document.getElementById('mapName').value,
      image_url: document.getElementById('imgUrl').value,
      creator: document.getElementById('creator').value,
      keywords: document.getElementById('keywords').value,
      grid_width: document.getElementById('gridW_num').value,
      grid_height: document.getElementById('gridH_num').value,
      cell_size_px: document.getElementById('ppi_num').value,
      avrae_cmd: document.getElementById('cmdOutput').innerText,
      submitted_by: "WebUser",
      is_free_use: true,
      is_approved: false 
    };

    // Send to Database
    const { error } = await supabase.from('maps').insert(payload);

    if (error) {
      console.error(error);
      statusMsg.innerText = "Error: " + error.message;
      statusMsg.style.color = "red";
      btn.disabled = false;
      btn.innerText = "Submit to Library";
    } else {
      statusMsg.innerText = "Success! Map submitted for approval.";
      statusMsg.style.color = "green";
      btn.innerText = "Submitted";
      
      // Clear inputs
      document.getElementById('mapName').value = "";
      document.getElementById('keywords').value = "";
    }
  }
</script>