<script>
  /* --- CONFIGURATION --- */
  const SUPABASE_URL = 'https://kcbvryvmcbfpsibxthhn.supabase.co';
  
  // ðŸ”´ CRITICAL: Ensure this starts with "eyJ...", NOT "YeyJ..."
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtjYnZyeXZtY2JmcHNpYnh0aGhuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1OTk1MzIsImV4cCI6MjA3OTE3NTUzMn0.9h81WHRCJfhouquG9tPHliY_5ezAbzKeDoLtGSARo5M'; 
  
  const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  /* --- AUTHENTICATION LOGIC --- */
  let currentUser = null;

  // 1. Handle Session State (Central Logic)
  function handleSession(session) {
    if (session) {
      console.log("âœ… User found:", session.user.email);
      currentUser = session.user;
      showForm();
      
      // Clean the URL (remove the ugly hash) safely
      if (window.location.hash && window.location.hash.includes('access_token')) {
         const newUrl = window.location.origin + window.location.pathname;
         window.history.replaceState(null, null, newUrl);
      }
    } else {
      console.log("âš ï¸ No user session found.");
      showLogin();
    }
  }

  // 2. Setup Listener (Fires when Supabase detects a change)
  db.auth.onAuthStateChange((event, session) => {
    console.log("ðŸ”„ Auth Event:", event);
    handleSession(session);
  });

  // 3. Manual Check on Load (Catches the user if the listener is too slow)
  // This is the "Safety Net" you were missing.
  document.addEventListener('DOMContentLoaded', async () => {
    console.log("ðŸš€ App started. Checking session...");
    const { data, error } = await db.auth.getSession();
    if (error) console.error("Session Error:", error);
    handleSession(data.session);
  });

  /* --- ACTIONS --- */
  async function login() {
    // CLEAN URL before redirecting to prevent "Header too large" errors
    const redirectUrl = window.location.origin + window.location.pathname;
    console.log("Redirecting to:", redirectUrl);
    
    await db.auth.signInWithOAuth({ 
      provider: 'discord',
      options: {
        redirectTo: redirectUrl
      }
    });
  }

  async function logout() {
    await db.auth.signOut();
    window.location.reload(); // Reload to clear state completely
  }

  /* --- UI TOGGLES --- */
  function showForm() {
    document.getElementById('login-section').style.display = 'none';
    document.getElementById('form-section').style.display = 'block';
    
    const meta = currentUser.user_metadata;
    const name = meta.full_name || meta.custom_claims?.global_name || meta.name || "User";
    document.getElementById('user-display').innerText = `Logged in as: ${name}`;
  }

  function showLogin() {
    currentUser = null;
    document.getElementById('login-section').style.display = 'block';
    document.getElementById('form-section').style.display = 'none';
  }

  /* --- MAP TOOL LOGIC (Unchanged) --- */
  const img = document.getElementById('preview-img');
  const overlay = document.getElementById('grid-overlay');
  const cmdOutput = document.getElementById('cmdOutput');
  const statusMsg = document.getElementById('statusMsg');
  const xAxis = document.getElementById('axis-x-container');
  const yAxis = document.getElementById('axis-y-container');
  
  const VISUAL_CELL_SIZE = 28; 

  function loadImage() {
    const url = document.getElementById('imgUrl').value;
    if(!url) return;

    statusMsg.innerText = "Loading...";
    statusMsg.style.color = "blue";
    document.getElementById('placeholder-text').style.display = 'none';

    img.removeAttribute('src'); 
    img.style.display = 'block'; 
    img.src = url; 
  }

  img.onload = function() {
    statusMsg.innerText = "";
    renderGrid();
  };

  img.onerror = function() {
    statusMsg.innerText = "âŒ Error: Invalid link or CORS block.";
    statusMsg.style.color = "red";
  };

  function calcGridFromPPI() {
    if(!img.naturalWidth) return;
    const ppi = parseInt(document.getElementById('ppi_num').value);
    const cols = Math.ceil(img.naturalWidth / ppi);
    const rows = Math.ceil(img.naturalHeight / ppi);
    
    document.getElementById('gridW_slider').value = cols;
    document.getElementById('gridW_num').value = cols;
    document.getElementById('gridH_slider').value = rows;
    document.getElementById('gridH_num').value = rows;
    renderGrid();
  }

  function calcPPIfromGrid() {
    if(!img.naturalWidth) return;
    const cols = parseInt(document.getElementById('gridW_num').value);
    const exactPPI = Math.round(img.naturalWidth / cols);
    
    document.getElementById('ppi_slider').value = exactPPI;
    document.getElementById('ppi_num').value = exactPPI;
    renderGrid();
  }

  function updateFromSlider(type) {
    if(type === 'ppi') {
        document.getElementById('ppi_num').value = document.getElementById('ppi_slider').value;
    } else if(type === 'w') {
        document.getElementById('gridW_num').value = document.getElementById('gridW_slider').value;
    } else if(type === 'h') {
        document.getElementById('gridH_num').value = document.getElementById('gridH_slider').value;
    }
    renderGrid();
  }

  function updateFromInput(type) {
    if(type === 'ppi') {
        document.getElementById('ppi_slider').value = document.getElementById('ppi_num').value;
    } else if(type === 'w') {
        document.getElementById('gridW_slider').value = document.getElementById('gridW_num').value;
    } else if(type === 'h') {
        document.getElementById('gridH_slider').value = document.getElementById('gridH_num').value;
    }
    renderGrid();
  }

  function renderGrid() {
    const w_cols = parseInt(document.getElementById('gridW_num').value);
    const h_rows = parseInt(document.getElementById('gridH_num').value);
    const ppi_val = parseInt(document.getElementById('ppi_num').value);

    if(img.naturalWidth > 0) {
        const scaleRatio = VISUAL_CELL_SIZE / ppi_val;
        img.style.width = (img.naturalWidth * scaleRatio) + 'px';
        img.style.height = "auto"; 
    }

    const overlayWidth = w_cols * VISUAL_CELL_SIZE;
    const overlayHeight = h_rows * VISUAL_CELL_SIZE;

    overlay.style.width = overlayWidth + 'px';
    overlay.style.height = overlayHeight + 'px';

    renderCoordinates(w_cols, h_rows);

    const url = document.getElementById('imgUrl').value || "URL";
    const cmd = `!map -bg "${url}" -mapsize ${w_cols}x${h_rows} -options dc${ppi_val} -t DM`;
    cmdOutput.innerText = cmd;
  }

  function renderCoordinates(cols, rows) {
    xAxis.innerHTML = '';
    for(let i=0; i<cols; i++) {
        const el = document.createElement('div');
        el.className = 'axis-label axis-x';
        el.innerText = getColumnLabel(i);
        el.style.left = (30 + (i * VISUAL_CELL_SIZE)) + 'px'; 
        el.style.width = VISUAL_CELL_SIZE + 'px';
        xAxis.appendChild(el);
    }

    yAxis.innerHTML = '';
    for(let i=0; i<rows; i++) {
        const el = document.createElement('div');
        el.className = 'axis-label axis-y';
        el.innerText = (i + 1);
        el.style.top = (25 + (i * VISUAL_CELL_SIZE)) + 'px'; 
        el.style.height = VISUAL_CELL_SIZE + 'px';
        yAxis.appendChild(el);
    }
  }

  function getColumnLabel(index) {
      let label = "";
      let n = index;
      while (n >= 0) {
          label = String.fromCharCode((n % 26) + 65) + label;
          n = Math.floor(n / 26) - 1;
      }
      return label;
  }

  async function submitMap() {
    const btn = document.getElementById('submit-btn');
    
    if (!document.getElementById('tosCheck').checked) return alert("Please confirm free to use.");
    if (!document.getElementById('imgUrl').value) return alert("URL required.");
    if (img.naturalWidth === 0) return alert("Load a valid image first.");

    if (!currentUser) return alert("You must be logged in!");

    btn.disabled = true;
    btn.innerText = "Sending...";

    const meta = currentUser.user_metadata;
    const discordName = meta.full_name || meta.custom_claims?.global_name || meta.name || "Unknown User";

    const payload = {
      name: document.getElementById('mapName').value,
      image_url: document.getElementById('imgUrl').value,
      creator: document.getElementById('creator').value,
      keywords: document.getElementById('keywords').value,
      grid_width: document.getElementById('gridW_num').value,
      grid_height: document.getElementById('gridH_num').value,
      cell_size_px: document.getElementById('ppi_num').value,
      avrae_cmd: document.getElementById('cmdOutput').innerText,
      submitted_by: discordName,
      is_free_use: true,
      is_approved: false 
    };

    const { error } = await db.from('maps').insert(payload);

    if (error) {
      console.error(error);
      statusMsg.innerText = "Error: " + error.message;
      statusMsg.style.color = "red";
      btn.disabled = false;
      btn.innerText = "Submit to Library";
    } else {
      statusMsg.innerText = "Success! Sent for approval.";
      statusMsg.style.color = "green";
      btn.innerText = "Submitted";
      document.getElementById('mapName').value = "";
    }
  }
</script>