---
layout: default
title: Submit Map
---
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  /* Simple layout for the tool */
  .submit-container { display: grid; grid-template-columns: 1fr 350px; gap: 20px; margin: 20px; }
  
  /* The Map Viewer */
  .map-viewer { 
    position: relative; 
    background: #222; 
    min-height: 500px; 
    overflow: hidden; 
    border: 2px solid #444;
  }
  
  #preview-img { 
    position: absolute; 
    top: 0; left: 0; 
    transform-origin: top left; 
    /* Max width constraint to keep it inside initially */
    max-width: 100%;
  }

  /* The Grid Overlay */
  #grid-overlay {
    position: absolute;
    top: 0; left: 0;
    pointer-events: none; /* Let clicks pass through to image */
    border: 1px solid red;
    box-sizing: border-box;
    /* Grid lines created by repeating gradient */
    background-image: 
      linear-gradient(to right, rgba(255, 0, 0, 0.5) 1px, transparent 1px),
      linear-gradient(to bottom, rgba(255, 0, 0, 0.5) 1px, transparent 1px);
    transform-origin: top left;
  }

  /* Controls Sidebar */
  .controls { background: #f4f4f4; padding: 20px; border-radius: 8px; color: #333; }
  .controls label { display: block; margin-top: 10px; font-weight: bold; font-size: 0.9em; }
  .controls input[type="text"], .controls input[type="url"], .controls input[type="number"] { 
    width: 100%; padding: 8px; box-sizing: border-box; 
  }
  .slider-group { display: flex; align-items: center; gap: 10px; }
  .slider-group input[type="range"] { flex-grow: 1; }

  .generated-cmd { 
    background: #222; color: #0f0; 
    font-family: monospace; padding: 10px; 
    word-break: break-all; margin-top: 20px; 
    border-radius: 4px;
  }

  button#submit-btn {
    background: #2ea44f; color: white; border: none; 
    padding: 15px; width: 100%; font-size: 1.1em; 
    margin-top: 20px; cursor: pointer; border-radius: 6px;
  }
  button#submit-btn:disabled { background: #ccc; }
</style>

<div class="intro-wrapper">
  <h1>Submit & Align Map</h1>
  <p>Paste a link, align the grid, and submit to the library.</p>
</div>

<div class="submit-container">
  <div class="map-viewer" id="viewPort">
    <img id="preview-img" src="" alt="Map Preview">
    <div id="grid-overlay"></div>
  </div>

  <div class="controls">
    <h3>1. Map Details</h3>
    <label>Image URL (Direct Link)</label>
    <input type="url" id="imgUrl" placeholder="https://i.imgur.com/..." onchange="loadImage()">

    <label>Map Name</label>
    <input type="text" id="mapName" placeholder="e.g. Forest Road">

    <label>Creator</label>
    <input type="text" id="creator" placeholder="e.g. Neutral Party">
    
    <label>Keywords</label>
    <input type="text" id="keywords" placeholder="forest, day, ambush">

    <hr>
    <h3>2. Grid Alignment</h3>
    
    <label>Grid Width (Squares)</label>
    <div class="slider-group">
      <input type="range" id="gridW_slider" min="5" max="100" value="25" oninput="updateGrid()">
      <input type="number" id="gridW_num" value="25" oninput="updateGrid()">
    </div>

    <label>Grid Height (Squares)</label>
    <div class="slider-group">
      <input type="range" id="gridH_slider" min="5" max="100" value="25" oninput="updateGrid()">
      <input type="number" id="gridH_num" value="25" oninput="updateGrid()">
    </div>

    <label>Pixels Per Cell (Zoom)</label>
    <small>Standard is 70px</small>
    <div class="slider-group">
      <input type="range" id="ppi_slider" min="30" max="200" value="70" oninput="updateGrid()">
      <input type="number" id="ppi_num" value="70" oninput="updateGrid()">
    </div>

    <hr>
    <h3>3. Result</h3>
    <div class="generated-cmd" id="cmdOutput">!map -bg ...</div>

    <label style="margin-top:10px; font-weight:normal;">
      <input type="checkbox" id="tosCheck"> I confirm this map is free to use.
    </label>

    <button id="submit-btn" onclick="submitMap()">Submit to Library</button>
    <p id="statusMsg"></p>
  </div>
</div>

<script>
  // --- 1. CONFIGURATION ---
  // REPLACE THESE WITH YOUR KEYS FROM SUPABASE
  const SUPABASE_URL = 'https://kcbvryvmcbfpsibxthhn.supabase.co';
  const SUPABASE_KEY = 'YOUR_ANON_KEY_HERE';
  const supabase = supabase.createClient(sb_publishable_cGXFwDjzWIWCdRRmcMZIcg_vnp1Azyo);

  // --- 2. APP STATE ---
  const img = document.getElementById('preview-img');
  const overlay = document.getElementById('grid-overlay');
  const cmdOutput = document.getElementById('cmdOutput');

  // --- 3. LOAD IMAGE ---
  function loadImage() {
    const url = document.getElementById('imgUrl').value;
    if(!url) return;
    img.src = url;
    img.onload = function() {
      updateGrid(); // Recalculate grid once image size is known
    }
    img.onerror = function() {
      alert("Could not load image. Check the link (CORS might be blocking it).");
    }
  }

  // --- 4. UPDATE GRID VISUALS ---
  function updateGrid() {
    // Sync Sliders and Number boxes
    const w = document.getElementById('gridW_num').value = document.getElementById('gridW_slider').value;
    const h = document.getElementById('gridH_num').value = document.getElementById('gridH_slider').value;
    const ppi = document.getElementById('ppi_num').value = document.getElementById('ppi_slider').value;

    // Calculate Dimensions
    const totalWidth = w * ppi;
    const totalHeight = h * ppi;

    // Apply to Overlay
    overlay.style.width = totalWidth + 'px';
    overlay.style.height = totalHeight + 'px';
    overlay.style.backgroundSize = `${ppi}px ${ppi}px`; // Controls the grid square size

    // Force Image to match the grid width (Visual alignment trick)
    // In VTTs, usually you stretch the image to fit the grid
    img.style.width = totalWidth + 'px';
    img.style.height = totalHeight + 'px';

    // Update Command String
    const url = document.getElementById('imgUrl').value || "[URL]";
    const cmd = `!map -bg ${url} -w ${w} -h ${h} --options c${ppi}`;
    cmdOutput.innerText = cmd;
  }

  // --- 5. SUBMIT TO SUPABASE ---
  async function submitMap() {
    const btn = document.getElementById('submit-btn');
    const status = document.getElementById('statusMsg');
    
    // Validation
    if (!document.getElementById('tosCheck').checked) return alert("Please confirm the map is free to use.");
    if (!document.getElementById('imgUrl').value) return alert("Image URL is required.");

    btn.disabled = true;
    btn.innerText = "Sending...";

    const payload = {
      name: document.getElementById('mapName').value,
      image_url: document.getElementById('imgUrl').value,
      creator: document.getElementById('creator').value,
      keywords: document.getElementById('keywords').value,
      grid_width: document.getElementById('gridW_num').value,
      grid_height: document.getElementById('gridH_num').value,
      cell_size_px: document.getElementById('ppi_num').value,
      avrae_cmd: document.getElementById('cmdOutput').innerText,
      submitted_by: "WebUser",
      is_free_use: true
    };

    // Send to Database
    const { error } = await supabase.from('maps').insert(payload);

    if (error) {
      console.error(error);
      status.innerText = "Error: " + error.message;
      status.style.color = "red";
      btn.disabled = false;
    } else {
      status.innerText = "Success! Map submitted for approval.";
      status.style.color = "green";
      btn.innerText = "Submitted";
    }
  }
</script>