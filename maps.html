---
layout: default
title: Map Index
---

<div class="hero-block">
  <h1>Curated D&D Battle Maps</h1>
  <p>Curated battle maps with fast search and optional Avrae setup commands.  All maps are offered free by creators, with links to source.</p>
  <p id="map-count-display">Loading map count...</p> <p>Help contribute to the collection!  Login with Discord to edit map cards (ie. add avrae settings or search keywords) or add map(s) to the collection.</p>
  
  <div id="auth-ui" style="margin-top: 10px; font-size: 0.85em;">
    <button id="login-btn" onclick="login()" class="tool-btn" style="display:none; background:var(--palette-brand-discord); border-color:var(--palette-brand-discord); color:var(--palette-white); padding: 4px 10px; font-size: 0.9em;">Login to Edit</button>
    
    <div id="user-info" style="display:none;">
      <span style="margin-right:10px;">Logged in as: <strong id="username-display"></strong></span>
      <button onclick="logout()" class="tool-btn" style="padding: 2px 8px; font-size: 0.8em;">Logout</button>
    </div>
  </div>
</div>

<div class="map-search-wrapper">
  <input type="text" id="mapSearchInput" placeholder="Type keywords, name, or creator...">
  
  <a href="/codex/map-submit" class="tool-btn" style="display:inline-flex; align-items:center; justify-content:center; height:42px; box-sizing:border-box; text-decoration:none;">
    + Submit Map
  </a>
</div>

<div class="map-gallery" id="gallery-container">
  </div>

<button id="load-more-btn" class="tool-btn" onclick="fetchMaps()" style="display:none; margin: 20px auto; padding: 10px 20px;">Load More Maps</button>


<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/**
 * auth-manager.js (EMBEDDED)
 * A reusable component to handle Supabase Auth for any project.
 */

// --- CONFIGURATION (Update this one place only) ---
const SUPABASE_CONFIG = {
    url: 'https://kcbvryvmcbfpsibxthhn.supabase.co',
    key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtjYnZyeXZtY2JmcHNpYnh0aGhuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1OTk1MzIsImV4cCI6MjA3OTE3NTUzMn0.9h81WHRCJfhouquG9tPHliY_5ezAbzKeDoLtGSARo5M'
};

class AuthManager {
    constructor() {
        // Initialize Supabase (assumes supabase-js script is loaded in HTML)
        if (typeof supabase === 'undefined') {
            console.error('Supabase JS SDK not found. Make sure to include the CDN script.');
            return;
        }
        this.db = supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.key);
        this.user = null;
    }

    /**
     * Initializes the auth listener.
     * @param {Function} onUserChange - Callback function (user) => { ... } runs whenever auth state changes.
     */
    init(onUserChange) {
        // 1. Check current session immediately
        this.db.auth.getSession().then(({ data }) => {
            this.handleSession(data.session, onUserChange);
        });

        // 2. Listen for future changes (login/logout/token refresh)
        this.db.auth.onAuthStateChange((event, session) => {
            this.handleSession(session, onUserChange);
        });
    }

    handleSession(session, callback) {
        this.user = session ? session.user : null;
        
        // Clean URL fragment (removes #access_token=... junk from URL bar after login)
        if (session && window.location.hash && window.location.hash.includes('access_token')) {
            const newUrl = window.location.origin + window.location.pathname + window.location.search;
            window.history.replaceState(null, null, newUrl);
        }

        if (callback) callback(this.user);
    }

    async login(provider = 'discord') {
        const redirectUrl = window.location.origin + window.location.pathname;
        await this.db.auth.signInWithOAuth({ 
            provider: provider, 
            options: { redirectTo: redirectUrl } 
        });
    }

    async logout() {
        await this.db.auth.signOut();
        window.location.reload();
    }
    
    // Placeholder for admin check (required by edit.html, included for consistency)
    isAdmin() {
         if (!this.user) return false;
         const meta = this.user.user_metadata;
         return meta && meta.is_admin === true; 
    }

    // Helper to get formatted name
    getUserName() {
        if (!this.user) return "Guest";
        const meta = this.user.user_metadata;
        return meta.full_name || meta.custom_claims?.global_name || meta.name || "User";
    }

    // Expose the raw client if specific pages need data fetching (like select/insert)
    getClient() {
        return this.db;
    }
}

// Export a singleton instance globally
window.authManager = new AuthManager();
</script>
<script>
  /* --- GLOBAL VARIABLES --- */
  let db; 
  let currentUser = null;
  
  // PAGINATION SETTINGS
  let currentPage = 0;
  const PAGE_SIZE = 24;
  let currentSearch = "";
  let isLoading = false;
  let reachedEnd = false;

  /* --- INITIALIZATION --- */
  document.addEventListener('DOMContentLoaded', async () => {
    
    // 1. Initialize the Auth Manager
    // This handles the connection, user session, and UI updates automatically
    if (window.authManager) {
        window.authManager.init((user) => {
            currentUser = user;
            db = window.authManager.getClient(); // Get the DB connection
            
            updateAuthUI(user);
            
            // CRITICAL FIX: Only call resetGallery/fetchMaps once Auth/DB is ready
            // and ensure we don't double load.
            const container = document.getElementById('gallery-container');
            // Check if it's the first page load AND the container is empty.
            if (currentPage === 0 && container.children.length === 0) {
                resetGallery(); 
            }
        });
    } else {
        // If window.authManager is still missing despite embedding, log the error.
        console.error("Auth Manager not loaded! Initializing failed.");
    }

    // 2. Setup Search Listener
    const searchInput = document.getElementById('mapSearchInput');
    let timeout = null;
    
    if(searchInput) {
      searchInput.addEventListener('input', (e) => {
          clearTimeout(timeout);
          timeout = setTimeout(() => {
              currentSearch = e.target.value.trim();
              resetGallery(); 
          }, 500); 
      });
    }
  });

  /* --- AUTH UI UPDATES --- */
  function updateAuthUI(user) {
    const loginBtn = document.getElementById('login-btn');
    const userInfo = document.getElementById('user-info');

    if (user) {
      loginBtn.style.display = 'none';
      userInfo.style.display = 'block';
      
      // Get name from the manager helper
      document.getElementById('username-display').innerText = window.authManager.getUserName();
    } else {
      currentUser = null;
      loginBtn.style.display = 'inline-block';
      userInfo.style.display = 'none';
    }

    // Re-render gallery to show/hide Edit buttons if user state changed
    const container = document.getElementById('gallery-container');
    // Only reload if maps are currently visible (i.e., we're not waiting for an initial load)
    if (container.children.length > 0 || currentPage > 0) { 
        resetGallery();
    }
  }

  // Connect HTML buttons to the Manager
  window.login = () => window.authManager.login();
  window.logout = () => window.authManager.logout();

  /* --- DATA FETCHING (Same logic as before, just using 'db') --- */
  
  function resetGallery() {
      const container = document.getElementById('gallery-container');
      const loadMoreBtn = document.getElementById('load-more-btn');
      
      container.innerHTML = ''; 
      currentPage = 0;
      reachedEnd = false;
      
      if(loadMoreBtn) loadMoreBtn.style.display = 'none';

      // Ensure DB is ready before fetching
      if(db) fetchMaps();
  }

  async function fetchMaps() {
    // CRITICAL: Ensure DB is set before proceeding
    if(isLoading || reachedEnd || !db) return; 
    isLoading = true;

    const container = document.getElementById('gallery-container');
    const loadMoreBtn = document.getElementById('load-more-btn');
    const countDisplay = document.getElementById('map-count-display'); // Get the new element
    
    if(loadMoreBtn) loadMoreBtn.innerText = "Loading...";

    try {
      // MODIFICATION: Request the total count using { count: 'exact' }
      let query = db
        .from('maps')
        .select('*', { count: 'exact' }) // <-- Added count option
        .eq('is_approved', true)
        .order('created_at', { ascending: false });

      if (currentSearch) {
        const term = `%${currentSearch}%`;
        query = query.or(`name.ilike.${term},creator.ilike.${term},keywords.ilike.${term}`);
      }

      const from = currentPage * PAGE_SIZE;
      const to = from + PAGE_SIZE - 1;
      query = query.range(from, to);

      // MODIFICATION: Destructure the count from the response
      const { data: maps, error, count } = await query;

      if (error) throw error;

      // MODIFICATION: Update the count display for the first page load/search
      if (currentPage === 0) {
        if (count && countDisplay) {
            const mapWord = count === 1 ? 'map' : 'maps';
            countDisplay.innerText = `Map Collection: ${count.toLocaleString()} ${mapWord}.`;
        } else if (countDisplay) {
             countDisplay.innerText = `No curated D&D battle maps found.`;
        }
      }
      
      if (currentPage === 0 && (!maps || maps.length === 0)) {
        container.innerHTML = `<p style="text-align:center; width:100%;">No maps found matching "${currentSearch}".</p>`;
        if(loadMoreBtn) loadMoreBtn.style.display = 'none';
        return;
      }

      // ... (rest of pagination logic remains the same)
      if (maps.length < PAGE_SIZE) {
          reachedEnd = true;
          if(loadMoreBtn) loadMoreBtn.style.display = 'none'; 
      } else {
          if(loadMoreBtn) {
              loadMoreBtn.style.display = 'block';
              loadMoreBtn.innerText = "Load More Maps";
          }
      }

      renderMapCards(maps);
      currentPage++; 

    } catch (err) {
      console.error("Load Error:", err);
      container.innerHTML += `<p style="color:var(--palette-danger); text-align:center;">Error loading maps.</p>`;
      // Optional: Set the count display to an error state as well
      if(countDisplay) countDisplay.innerText = "Error loading map count.";
    } finally {
        isLoading = false;
    }
  }

  function renderMapCards(maps) {
    const container = document.getElementById('gallery-container');
    
    maps.forEach(map => {
        const card = document.createElement('div');
        card.className = 'map-card';
        
        const creatorDisplay = map.source_url 
          ? `<a href="${map.source_url}" target="_blank" rel="noopener noreferrer">${map.creator}</a>` 
          : map.creator;

        // Check currentUser to decide if we show the edit button
        const editButtonHtml = currentUser 
          ? `<a href="/codex/edit?id=${map.id}" class="edit-btn">✏️ Edit / Revise</a>` 
          : '';

        const thumbUrl = `https://wsrv.nl/?url=${encodeURIComponent(map.image_url)}&w=400&output=webp`;

        card.innerHTML = `
          <a href="${map.image_url}" class="map-thumbnail-link" target="_blank" title="View Full Image">
            <img 
                src="${thumbUrl}" 
                data-original="${map.image_url}"
                alt="${map.name}" 
                class="map-thumbnail" 
                loading="lazy"
                onerror="this.onerror=null; this.src=this.dataset.original;"
            >
          </a>

          <div class="map-card-info">
            <h2>${map.name}</h2>
            <p><strong>Creator:</strong> ${creatorDisplay}</p>
            
            ${ map.grid_width ? `<p><strong>Dimensions:</strong> ${map.grid_width}x${map.grid_height}</p>` : '' }

            <p><strong>Avrae Map Code:</strong></p>
            <div class="copy-wrapper">
               <code class="copy-target">${map.avrae_cmd || 'Not submitted'}</code>
               <button class="copy-button">Copy</button>
            </div>
            
            <p style="font-size:0.85em; color:var(--color-text-muted); margin-top:5px;">Tags: ${map.keywords || ''}</p>
            ${editButtonHtml}
          </div>
        `;
        container.appendChild(card);
    });

    setupInteractions(container);
  }

  function setupInteractions(container) {
    container.querySelectorAll('.copy-button').forEach(btn => {
      btn.onclick = () => {
        const codeEl = btn.previousElementSibling;
        if(!codeEl) return;
        navigator.clipboard.writeText(codeEl.innerText);
        const oldText = btn.innerText;
        btn.innerText = 'Copied!';
        btn.style.color = 'var(--palette-success)';
        setTimeout(() => { 
            btn.innerText = oldText; 
            btn.style.color = ''; 
        }, 2000);
      };
    });
  }
</script>