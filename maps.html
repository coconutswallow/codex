---
layout: default
title: Map Index
---
<link rel="stylesheet" href="/codex/assets/css/style.css">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<div class="intro-wrapper">
  <h1>Maps Index</h1>
  <p>Community submitted maps for Avrae. <a href="/codex/map-submit">Submit a new map here</a>.</p>
  
  <div id="auth-ui" style="margin-top: 15px; font-size: 0.9em;">
    <button id="login-btn" onclick="login()" class="tool-btn" style="display:none;">Login to Edit</button>
    <div id="user-info" style="display:none;">
      <span>Logged in as: <strong id="username-display"></strong></span>
      <button onclick="logout()" class="tool-btn">Logout</button>
    </div>
  </div>
</div>

<div class="map-search-wrapper">
  <label for="mapSearchInput">Search Maps:</label>
  <input type="text" id="mapSearchInput" placeholder="Type keywords, name, or creator...">
</div>

<div class="map-gallery" id="gallery-container">
  <p style="text-align:center; color:#666; margin-top: 50px;">Loading library...</p>
</div>

<script>
  /* --- CONFIGURATION --- */
  const SUPABASE_URL = 'https://kcbvryvmcbfpsibxthhn.supabase.co';
  const SUPABASE_KEY = 'YOUR_ANON_KEY_HERE'; 
  const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  let currentUser = null;

  /* --- AUTH & INIT --- */
  document.addEventListener('DOMContentLoaded', () => {
    initAuth();
  });

  function initAuth() {
    db.auth.onAuthStateChange((event, session) => {
      handleSession(session);
    });
    db.auth.getSession().then(({data}) => handleSession(data.session));
  }

  function handleSession(session) {
    const loginBtn = document.getElementById('login-btn');
    const userInfo = document.getElementById('user-info');

    if (session) {
      currentUser = session.user;
      loginBtn.style.display = 'none';
      userInfo.style.display = 'block';
      
      const meta = currentUser.user_metadata;
      document.getElementById('username-display').innerText = meta.full_name || meta.name || "User";
    } else {
      currentUser = null;
      loginBtn.style.display = 'inline-block';
      userInfo.style.display = 'none';
    }
    
    // Re-render maps to show/hide Edit buttons based on login state
    fetchAndRenderMaps(); 
  }

  async function login() {
    const redirectUrl = window.location.href; // Come back to this exact page
    await db.auth.signInWithOAuth({ provider: 'discord', options: { redirectTo: redirectUrl } });
  }

  async function logout() {
    await db.auth.signOut();
    window.location.reload();
  }

  /* --- RENDER LOGIC --- */
  async function fetchAndRenderMaps() {
    const container = document.getElementById('gallery-container');
    // Don't clear container yet to prevent flashing, but we will clear it before appending

    const { data: maps, error } = await db
      .from('maps')
      .select('*')
      .eq('is_approved', true)
      .order('created_at', { ascending: false });

    if (error) {
      container.innerHTML = `<p style="color:var(--palette-danger); text-align:center;">Error.</p>`;
      return;
    }

    container.innerHTML = ''; // Clear now

    maps.forEach(map => {
      const card = document.createElement('div');
      card.className = 'map-card';
      const searchString = `${map.name} ${map.creator} ${map.keywords || ''}`.toLowerCase();
      card.setAttribute('data-search', searchString);

      const creatorDisplay = map.source_url 
        ? `<a href="${map.source_url}" target="_blank" rel="noopener noreferrer">${map.creator}</a>` 
        : map.creator;

      // EDIT BUTTON LOGIC
      // Only show if user is logged in
      const editButtonHtml = currentUser 
        ? `<a href="/codex/edit?id=${map.id}" class="edit-btn">✏️ Edit / Revise</a>` 
        : '';

      card.innerHTML = `
        <a href="${map.image_url}" class="map-thumbnail-link" target="_blank">
          <img src="${map.image_url}" alt="${map.name}" class="map-thumbnail" loading="lazy">
        </a>

        <div class="map-card-info">
          <h2>${map.name}</h2>
          <p><strong>Creator:</strong> ${creatorDisplay}</p>
          ${ map.grid_width ? `<p><strong>Dim:</strong> ${map.grid_width}x${map.grid_height}</p>` : '' }

          <div class="copy-wrapper">
             <code class="copy-target">${map.avrae_cmd || 'Not submitted'}</code>
             <button class="copy-button">Copy</button>
          </div>
          
          <p style="font-size:0.85em; color:var(--color-text-muted); margin-top:5px;">Tags: ${map.keywords || ''}</p>
          
          ${editButtonHtml}
        </div>
      `;
      container.appendChild(card);
    });

    setupInteractions();
  }

  function setupInteractions() {
    const searchInput = document.getElementById('mapSearchInput');
    const allCards = document.querySelectorAll('.map-card');

    if(searchInput) {
        searchInput.addEventListener('keyup', () => {
          const filterText = searchInput.value.toLowerCase().trim();
          allCards.forEach(card => {
            card.style.display = card.getAttribute('data-search').includes(filterText) ? 'flex' : 'none';
          });
        });
    }

    document.querySelectorAll('.copy-button').forEach(btn => {
      btn.addEventListener('click', () => {
        navigator.clipboard.writeText(btn.previousElementSibling.innerText);
        const oldText = btn.innerText;
        btn.innerText = 'Copied!';
        btn.style.color = 'var(--palette-success)';
        setTimeout(() => { btn.innerText = oldText; btn.style.color = ''; }, 2000);
      });
    });
  }
</script>