<script>
  /* --- GLOBAL VARIABLES --- */
  let db;
  let currentUser = null;
  let originalMapId = null;
  let isAdmin = false; 
  
  const VISUAL_CELL_SIZE = 28;
  const img = document.getElementById('preview-img');
  const overlay = document.getElementById('grid-overlay');

  /* --- INITIALIZATION --- */
  document.addEventListener('DOMContentLoaded', async () => {
    // 1. Get Map ID from URL immediately
    const params = new URLSearchParams(window.location.search);
    originalMapId = params.get('id');

    // 2. Initialize Auth Manager and wait for session check
    if (!window.authManager) {
        console.error("Auth Manager not found. Cannot proceed.");
        alert("System error: Auth manager script missing.");
        return;
    }

    // Pass a callback function to init that runs AFTER the user/session check
    window.authManager.init((user) => {
        currentUser = user;
        db = window.authManager.getClient(); // Get the DB client

        // 3. Security Guard: Redirect if not logged in
        if (!user) {
            alert("You must be logged in to edit.");
            // Delay redirect slightly to ensure message is seen
            setTimeout(() => { window.location.href = "/codex/maps/"; }, 100); 
            return;
        }

        // --- Everything below this line runs ONLY if a user is confirmed ---
        
        // Check for admin status
        isAdmin = window.authManager.isAdmin(); 
        if (isAdmin) {
             document.getElementById('admin-badge').style.display = 'inline-block';
             document.getElementById('save-btn').innerText = 'Save Changes (Admin)';
        } else {
             document.getElementById('save-btn').innerText = 'Save New Version';
        }

        // 4. Load Data now that ID and Auth are confirmed
        if(originalMapId) {
             loadMapData(originalMapId);
        } else {
             alert("No map ID provided.");
             document.getElementById('loading-msg').innerText = "Error: No Map ID Provided.";
        }
    });
  });

  /* --- DATA LOADING --- */
  async function loadMapData(id) {
      // Ensure DB client is available
      if(!db) {
        document.getElementById('loading-msg').innerText = "Error: Database client not ready.";
        return;
      }
      
      const { data, error } = await db.from('maps').select('*').eq('id', id).single();
      
      if(error || !data) {
          alert("Error loading map data. " + (error ? error.message : "Data not found."));
          console.error(error);
          return;
      }
      
      const hasAvrae = data.avrae_cmd && data.avrae_cmd.length > 5;

      // Populate Fields (Core Info)
      document.getElementById('mapName').value = data.name;
      document.getElementById('imgUrl').value = data.image_url;
      document.getElementById('creator').value = data.creator;
      document.getElementById('sourceUrl').value = data.source_url || '';
      document.getElementById('keywords').value = data.keywords || '';

      // Populate Grid Settings - Check for existing Avrae data
      if (hasAvrae) {
        document.getElementById('avraeToggle').checked = true;
        document.getElementById('ppi_num').value = data.cell_size_px || 40;
        document.getElementById('ppi_slider').value = data.cell_size_px || 40;
        document.getElementById('gridW_num').value = data.grid_width || 30;
        document.getElementById('gridH_num').value = data.grid_height || 30;
      } else {
        document.getElementById('avraeToggle').checked = false;
        document.getElementById('ppi_num').value = 40;
        document.getElementById('ppi_slider').value = 40;
        document.getElementById('gridW_num').value = 30;
        document.getElementById('gridH_num').value = 30;
      }
      
      document.getElementById('offX').value = data.offset_x || 0; 
      document.getElementById('offY').value = data.offset_y || 0; 
      
      toggleAvraeMode(); // Initial call to show/hide settings based on data

      // Load Image & UI
      document.getElementById('loading-msg').style.display = 'none';
      document.getElementById('editor-ui').style.display = 'block';
      
      img.src = data.image_url;
      img.onload = () => {
          img.style.display = 'block';
          renderGrid();
      };
      img.onerror = () => {
          alert("Could not load original image.");
      };
  }
  
  /* NEW: Toggle Avrae Settings visibility and grid overlay */
  function toggleAvraeMode() {
    const isOn = document.getElementById('avraeToggle').checked;
    const settingsDiv = document.getElementById('avrae-settings-container');
    
    settingsDiv.style.display = isOn ? 'block' : 'none';
    overlay.style.display = isOn ? 'block' : 'none';
    renderGrid(); 
  }


  /* --- RENDER & CALC LOGIC --- */
  function calcGridFromPPI() {
    if(!img.naturalWidth) return;
    const ppi = parseInt(document.getElementById('ppi_num').value);
    document.getElementById('gridW_num').value = Math.ceil(img.naturalWidth / ppi);
    document.getElementById('gridH_num').value = Math.ceil(img.naturalHeight / ppi);
    renderGrid();
  }

  function calcPPIfromGrid() {
    if(!img.naturalWidth) return;
    const cols = parseInt(document.getElementById('gridW_num').value);
    const exactPPI = Math.round(img.naturalWidth / cols);
    document.getElementById('ppi_slider').value = exactPPI;
    document.getElementById('ppi_num').value = exactPPI;
    renderGrid();
  }

  function updateFromSlider(type) {
    if(type === 'ppi') document.getElementById('ppi_num').value = document.getElementById('ppi_slider').value;
    renderGrid();
  }
  function updateFromInput(type) {
    if(type === 'ppi') document.getElementById('ppi_slider').value = document.getElementById('ppi_num').value;
    renderGrid();
  }

  function renderGrid() {
    const w = parseInt(document.getElementById('gridW_num').value);
    const h = parseInt(document.getElementById('gridH_num').value);
    const ppi = parseInt(document.getElementById('ppi_num').value);
    const ox = parseInt(document.getElementById('offX').value) || 0;
    const oy = parseInt(document.getElementById('offY').value) || 0;
    const isAvraeOn = document.getElementById('avraeToggle').checked;

    if(img.naturalWidth > 0) {
        if (isAvraeOn) {
            const scale = VISUAL_CELL_SIZE / ppi;
            img.style.width = (img.naturalWidth * scale) + 'px';
            img.style.height = "auto";
            img.style.transform = `translate(${ox * scale}px, ${oy * scale}px)`;
        } else {
            img.style.width = "100%"; 
            img.style.height = "auto";
            img.style.transform = "none";
        }
    }

    if (isAvraeOn) {
        overlay.style.width = (w * VISUAL_CELL_SIZE) + 'px';
        overlay.style.height = (h * VISUAL_CELL_SIZE) + 'px';
    } else {
        overlay.style.width = '0px';
        overlay.style.height = '0px';
    }
    
    let cmd = "!map ...";
    if (isAvraeOn) {
        let options = `dc${ppi}`;
        if (ox > 0 || oy > 0) {
            options += ` -o${ox}:${oy}`;
        }
        cmd = `!map -bg "${document.getElementById('imgUrl').value}" -mapsize ${w}x${h} -options ${options} -t DM`;
    }
    document.getElementById('cmdOutput').innerText = cmd;
  }

  /* --- VERSIONING SAVE (Conditional Save) --- */
  async function saveMap() {
      if (isAdmin) {
          await overwriteMap();
      } else {
          await saveNewVersion();
      }
  }

  /* Admin-only direct overwrite */
  async function overwriteMap() {
      const btn = document.getElementById('save-btn');
      const msg = document.getElementById('statusMsg');
      
      if(!db || !currentUser) { // Double check auth before running
        alert("Authentication lost. Please reload and log in."); 
        btn.disabled = false;
        btn.innerText = "Save Changes (Admin)";
        return;
      }

      btn.disabled = true;
      btn.innerText = "Saving changes...";
      msg.innerText = "";

      const isAvraeOn = document.getElementById('avraeToggle').checked;
      const currentEditor = window.authManager.getUserName();
      
      let payload = {
          name: document.getElementById('mapName').value,
          keywords: document.getElementById('keywords').value,
          last_edit: currentEditor,        
          edit_date: new Date().toISOString()
      };
      
      if (isAvraeOn) {
          payload.grid_width = document.getElementById('gridW_num').value;
          payload.grid_height = document.getElementById('gridH_num').value;
          payload.cell_size_px = document.getElementById('ppi_num').value;
          payload.avrae_cmd = document.getElementById('cmdOutput').innerText;
          payload.offset_x = document.getElementById('offX').value;
          payload.offset_y = document.getElementById('offY').value;
      } else {
          payload.grid_width = 0;
          payload.grid_height = 0;
          payload.cell_size_px = 0;
          payload.avrae_cmd = "";
          payload.offset_x = 0;
          payload.offset_y = 0;
      }

      const { error: updateError } = await db.from('maps')
          .update(payload)
          .eq('id', originalMapId);

      if(updateError) {
           msg.innerText = "Error saving changes: " + updateError.message;
           msg.style.color = "var(--palette-danger)";
           btn.disabled = false;
           btn.innerText = "Save Changes (Admin)";
      } else {
           msg.innerText = "Success! Map updated directly.";
           msg.style.color = "var(--palette-success)";
           setTimeout(() => { window.location.href = "/codex/maps"; }, 1500);
      }
  }

  /* Existing logic for non-admin users */
  async function saveNewVersion() {
      const btn = document.getElementById('save-btn');
      const msg = document.getElementById('statusMsg');
      
      if(!db || !currentUser) { // Double check auth before running
        alert("Authentication lost. Please reload and log in."); 
        btn.disabled = false;
        btn.innerText = "Save New Version";
        return;
      }

      btn.disabled = true;
      btn.innerText = "Archiving old version...";
      msg.innerText = "";
      
      const isAvraeOn = document.getElementById('avraeToggle').checked;

      /* 1. ARCHIVE OLD MAP */
      const { data: oldData, error: fetchError } = await db
          .from('maps')
          .select('submitted_by')
          .eq('id', originalMapId)
          .single();

      // Attempt to archive regardless of fetch success
      const { error: archiveError } = await db.rpc('archive_map', { 
          map_id: parseInt(originalMapId) 
      });

      if(archiveError) {
          console.error(archiveError);
          msg.innerText = "Error archiving old version. Saving new version anyway...";
          msg.style.color = "var(--palette-danger)";
      }

      btn.innerText = "Saving new version...";

      /* 2. INSERT NEW VERSION */
      const currentEditor = window.authManager.getUserName();
      const originalSubmitter = oldData ? oldData.submitted_by : currentEditor; 

      let payload = {
          name: document.getElementById('mapName').value,
          image_url: document.getElementById('imgUrl').value,
          creator: document.getElementById('creator').value,
          source_url: document.getElementById('sourceUrl').value,
          keywords: document.getElementById('keywords').value,
          avrae_cmd: document.getElementById('cmdOutput').innerText,
          is_free_use: true,
          submitted_by: originalSubmitter, 
          last_edit: currentEditor,        
          edit_date: new Date().toISOString() 
      };
      
      if (isAvraeOn) {
          payload.grid_width = document.getElementById('gridW_num').value;
          payload.grid_height = document.getElementById('gridH_num').value;
          payload.cell_size_px = document.getElementById('ppi_num').value;
          payload.offset_x = document.getElementById('offX').value;
          payload.offset_y = document.getElementById('offY').value;
      } else {
          payload.grid_width = 0;
          payload.grid_height = 0;
          payload.cell_size_px = 0;
          payload.avrae_cmd = "";
          payload.offset_x = 0;
          payload.offset_y = 0;
      }

      const { error: insertError } = await db.from('maps').insert(payload);

      if(insertError) {
           msg.innerText = "Error saving new version: " + insertError.message;
           msg.style.color = "var(--palette-danger)";
           btn.disabled = false;
           btn.innerText = "Save New Version";
      } else {
           msg.innerText = "Success! New version submitted.";
           msg.style.color = "var(--palette-success)";
           setTimeout(() => { window.location.href = "/codex/maps"; }, 1500);
      }
  }
</script>