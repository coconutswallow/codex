---
layout: default
title: Edit Map
---

<div class="hero-block">
  <h1>Revise Map Data</h1>
  <p>Create a new version of an existing map. Core image data is locked.</p>
  <div style="margin-top: 20px;">
    <a href="{{ '/maps' | relative_url }}" class="tool-btn" style="text-decoration: none;">&larr; Cancel Editing</a>
  </div>
</div>

<div class="submit-container">
  
  <div class="map-viewer" id="viewPort">
    <div class="canvas-wrapper" id="canvasWrapper">
        <img id="preview-img" src="" alt="" style="display:none;">
        <div id="grid-overlay"></div>
    </div>
  </div>

  <div class="controls">
    <div id="loading-msg" style="text-align:center; padding:20px;">Loading Map Data...</div>
    
    <div id="editor-ui" style="display:none;">
        
        <div class="section" style="background:#eee; opacity: 0.8;">
            <h3>Core Info (Locked)</h3>
            <label>Map Name</label>
            <input type="text" id="mapName">
            
            <label>Image URL</label>
            <input type="text" id="imgUrl" disabled>
            <label>Creator</label>
            <input type="text" id="creator" disabled>
             <input type="hidden" id="sourceUrl">
        </div>

        <div class="section">
            <h3>Revise Settings</h3>
            
            <label>Search Keywords</label>
            <input type="text" id="keywords" placeholder="forest, road, day">
            
            <hr style="margin: 15px 0; border-top: 1px dashed #ccc;">

            <label>Pixels Per Cell</label>
            <div class="slider-group">
              <input type="range" id="ppi_slider" min="20" max="150" oninput="updateFromSlider('ppi')">
              <input type="number" id="ppi_num" oninput="updateFromInput('ppi')">
            </div>
    
            <label>Grid W / H</label>
            <div class="slider-group">
              <input type="number" id="gridW_num" oninput="updateFromInput('w')">
              <span style="font-weight:bold;">x</span>
              <input type="number" id="gridH_num" oninput="updateFromInput('h')">
            </div>
            
            <div style="text-align:right; margin-top:5px;">
               <button class="tool-btn" onclick="calcPPIfromGrid()">Fit Image to Grid</button>
               <button class="tool-btn" onclick="calcGridFromPPI()">Auto-Set W/H</button>
            </div>
            
            <label>Offset (X / Y)</label>
            <div style="display:flex; gap:10px;">
                <input type="number" id="offX" value="0" oninput="renderGrid()">
                <input type="number" id="offY" value="0" oninput="renderGrid()">
            </div>

            <label style="margin-top: 20px;">Generated Command</label>
            <div class="generated-cmd" id="cmdOutput">!map ...</div>
        </div>

        <div class="section">
            <button id="save-btn" onclick="saveVersion()">Save New Version</button>
            <p id="statusMsg"></p>
        </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="/js/auth-manager.js"></script>

<script>
  /* --- GLOBAL VARIABLES --- */
  let db;
  let currentUser = null;
  let originalMapId = null;
  
  const VISUAL_CELL_SIZE = 28;
  const img = document.getElementById('preview-img');
  const overlay = document.getElementById('grid-overlay');

  /* --- INITIALIZATION --- */
  document.addEventListener('DOMContentLoaded', async () => {
    // 1. Get Map ID from URL immediately
    const params = new URLSearchParams(window.location.search);
    originalMapId = params.get('id');

    // 2. Initialize Auth Manager
    if (!window.authManager) {
        console.error("Auth Manager not found.");
        return;
    }

    window.authManager.init((user) => {
        currentUser = user;
        db = window.authManager.getClient(); // Get the DB client

        // 3. Security Guard: Redirect if not logged in
        if (!user) {
            alert("You must be logged in to edit.");
            window.location.href = "/codex/maps/"; 
            return;
        }

        // 4. Load Data if ID exists
        if(originalMapId) {
             loadMapData(originalMapId);
        } else {
             alert("No map ID provided.");
        }
    });
  });

  /* --- DATA LOADING --- */
  async function loadMapData(id) {
      if(!db) return;

      const { data, error } = await db.from('maps').select('*').eq('id', id).single();
      
      if(error || !data) {
          alert("Error loading map data.");
          console.error(error);
          return;
      }

      // Populate Fields
      document.getElementById('mapName').value = data.name;
      document.getElementById('imgUrl').value = data.image_url;
      document.getElementById('creator').value = data.creator;
      document.getElementById('sourceUrl').value = data.source_url || '';
      document.getElementById('keywords').value = data.keywords || '';

      // Populate Grid Settings (or defaults)
      document.getElementById('ppi_num').value = data.cell_size_px || 70;
      document.getElementById('ppi_slider').value = data.cell_size_px || 70;
      document.getElementById('gridW_num').value = data.grid_width || 30;
      document.getElementById('gridH_num').value = data.grid_height || 30;
      
      document.getElementById('offX').value = 0;
      document.getElementById('offY').value = 0;

      // Load Image & UI
      document.getElementById('loading-msg').style.display = 'none';
      document.getElementById('editor-ui').style.display = 'block';
      
      img.src = data.image_url;
      img.onload = () => {
          img.style.display = 'block';
          renderGrid();
      };
      img.onerror = () => {
          alert("Could not load original image.");
      };
  }

  /* --- RENDER & CALC LOGIC --- */
  function calcGridFromPPI() {
    if(!img.naturalWidth) return;
    const ppi = parseInt(document.getElementById('ppi_num').value);
    document.getElementById('gridW_num').value = Math.ceil(img.naturalWidth / ppi);
    document.getElementById('gridH_num').value = Math.ceil(img.naturalHeight / ppi);
    renderGrid();
  }

  function calcPPIfromGrid() {
    if(!img.naturalWidth) return;
    const cols = parseInt(document.getElementById('gridW_num').value);
    const exactPPI = Math.round(img.naturalWidth / cols);
    document.getElementById('ppi_slider').value = exactPPI;
    document.getElementById('ppi_num').value = exactPPI;
    renderGrid();
  }

  function updateFromSlider(type) {
    if(type === 'ppi') document.getElementById('ppi_num').value = document.getElementById('ppi_slider').value;
    renderGrid();
  }
  function updateFromInput(type) {
    if(type === 'ppi') document.getElementById('ppi_slider').value = document.getElementById('ppi_num').value;
    renderGrid();
  }

  function renderGrid() {
    const w = parseInt(document.getElementById('gridW_num').value);
    const h = parseInt(document.getElementById('gridH_num').value);
    const ppi = parseInt(document.getElementById('ppi_num').value);
    const ox = parseInt(document.getElementById('offX').value) || 0;
    const oy = parseInt(document.getElementById('offY').value) || 0;

    if(img.naturalWidth > 0) {
        const scale = VISUAL_CELL_SIZE / ppi;
        img.style.width = (img.naturalWidth * scale) + 'px';
        img.style.height = "auto";
        img.style.transform = `translate(${ox * scale}px, ${oy * scale}px)`;
    }

    overlay.style.width = (w * VISUAL_CELL_SIZE) + 'px';
    overlay.style.height = (h * VISUAL_CELL_SIZE) + 'px';
    
    const cmd = `!map -bg "${document.getElementById('imgUrl').value}" -mapsize ${w}x${h} -options dc${ppi} -o${ox}:${oy} -t DM`;
    document.getElementById('cmdOutput').innerText = cmd;
  }

  /* --- VERSIONING SAVE --- */
  async function saveVersion() {
      const btn = document.getElementById('save-btn');
      const msg = document.getElementById('statusMsg');
      
      if(!db || !currentUser) return;

      btn.disabled = true;
      btn.innerText = "Archiving old version...";

      /* 1. ARCHIVE OLD MAP */
      // We fetch the old submitter first so we don't lose that info
      const { data: oldData, error: fetchError } = await db
          .from('maps')
          .select('submitted_by')
          .eq('id', originalMapId)
          .single();

      const { error: archiveError } = await db.rpc('archive_map', { 
          map_id: parseInt(originalMapId) 
      });

      if(archiveError) {
          console.error(archiveError);
          msg.innerText = "Error archiving old version.";
          msg.style.color = "var(--palette-danger)";
          btn.disabled = false;
          return;
      }

      btn.innerText = "Saving new version...";

      /* 2. INSERT NEW VERSION */
      // Use authManager helper for clean name
      const currentEditor = window.authManager.getUserName();
      const originalSubmitter = oldData ? oldData.submitted_by : currentEditor;

      const payload = {
          name: document.getElementById('mapName').value,
          image_url: document.getElementById('imgUrl').value,
          creator: document.getElementById('creator').value,
          source_url: document.getElementById('sourceUrl').value,
          keywords: document.getElementById('keywords').value,
          grid_width: document.getElementById('gridW_num').value,
          grid_height: document.getElementById('gridH_num').value,
          cell_size_px: document.getElementById('ppi_num').value,
          avrae_cmd: document.getElementById('cmdOutput').innerText,
          is_free_use: true,
          submitted_by: originalSubmitter, 
          last_edit: currentEditor,        
          edit_date: new Date().toISOString() 
      };

      const { error: insertError } = await db.from('maps').insert(payload);

      if(insertError) {
           msg.innerText = "Error saving new version: " + insertError.message;
           msg.style.color = "var(--palette-danger)";
           btn.disabled = false;
           btn.innerText = "Save New Version";
      } else {
           msg.innerText = "Success! New version submitted.";
           msg.style.color = "var(--palette-success)";
           setTimeout(() => { window.location.href = "/codex/maps"; }, 1500);
      }
  }
</script>